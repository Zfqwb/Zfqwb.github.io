

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="nitto">
  <meta name="keywords" content="">
  
  <title>MySQL高级-03 - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/toubudaziji.css">
<link rel="stylesheet" href="/css/gundongtiao.css">
<link rel="stylesheet" href="/css/shubiao.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"zfqwb.github.io","root":"/","version":"1.8.9","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":21111747,"cnzz":null,"leancloud":{"app_id":"bMWk1sw4iFwEPTeRxqFOkxvq-gzGzoHsz","app_key":"sDMo4aGFa1dFrXYs2oXkNaVY","server_url":"https://bmwk1sw4.lc-cn-n1-shared.com"}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  <meta name="baidu-site-verification" content="code-vbtyv0liY1" />
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>nitto</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="MySQL高级-03">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-05-03 19:34" pubdate>
        2020年5月3日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      9k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      110
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">MySQL高级-03</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2 个月前
                
              </p>
            
            <div class="markdown-body">
              <h3 id="一、MySQL存储过程和函数"><a href="#一、MySQL存储过程和函数" class="headerlink" title="一、MySQL存储过程和函数"></a>一、MySQL存储过程和函数</h3><h4 id="1-存储过程和函数的概念"><a href="#1-存储过程和函数的概念" class="headerlink" title="1. 存储过程和函数的概念"></a>1. 存储过程和函数的概念</h4><ul>
<li>存储过程和函数是：事先经过编译并存储在数据库中的一段 SQL 语句的集合</li>
<li>存储过程和函数，类似于java里的方法<ul>
<li>存储过程和函数，是存储了多行sql语句</li>
<li>java是存储了多行java代码</li>
</ul>
</li>
</ul>
<h4 id="2-存储过程和函数的好处"><a href="#2-存储过程和函数的好处" class="headerlink" title="2. 存储过程和函数的好处"></a>2. 存储过程和函数的好处</h4><ul>
<li>存储过程和函数可以重复使用，减轻开发人员的工作量。类似于java中方法可以多次调用</li>
<li>减少网络流量，存储过程和函数位于服务器上，调用的时候只需要传递名称和参数即可</li>
<li>减少数据在数据库和应用服务器之间的传输，可以提高数据处理的效率</li>
<li>将一些业务逻辑在数据库层面来实现，可以减少代码层面的业务处理</li>
</ul>
<h4 id="3-存储过程和函数的区别"><a href="#3-存储过程和函数的区别" class="headerlink" title="3. 存储过程和函数的区别"></a>3. 存储过程和函数的区别</h4><ul>
<li>函数必须有返回值</li>
<li>存储过程没有返回值</li>
</ul>
<h4 id="4-创建存储过程"><a href="#4-创建存储过程" class="headerlink" title="4. 创建存储过程"></a>4. 创建存储过程</h4><ul>
<li>小知识</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">&#x2F;*<br>	该关键字用来声明sql语句的分隔符，告诉MySQL该段命令已经结束！<br>	sql语句默认的分隔符是分号，但是有的时候我们需要一条功能sql语句中包含分号，但是并不作为结束标识。<br>	这个时候就可以使用DELIMITER来指定分隔符了！<br>*&#x2F;<br>-- 标准语法<br>DELIMITER 分隔符<br>delimiter：  [dɪ&#39;lɪmɪtə]  分隔符<br>因为在存储过程中会有多条SQL语句，那如果还是以分号分隔，那mysql就会认为这存储多过程中的第一条sql语句执行完就结束了，所以我们需要在使用存储过程的时候修改分隔符<br></code></pre></div></td></tr></table></figure>

<ul>
<li>数据准备</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 创建db8数据库<br>CREATE DATABASE db8;<br><br>-- 使用db8数据库<br>USE db8;<br><br>-- 创建学生表<br>CREATE TABLE student(<br>	id INT PRIMARY KEY AUTO_INCREMENT,	-- 学生id<br>	NAME VARCHAR(20),					-- 学生姓名<br>	age INT,							-- 学生年龄<br>	gender VARCHAR(5),					-- 学生性别<br>	score INT                           -- 学生成绩<br>);<br>-- 添加数据<br>INSERT INTO student VALUES (NULL,&#39;张三&#39;,23,&#39;男&#39;,95),(NULL,&#39;李四&#39;,24,&#39;男&#39;,98),<br>(NULL,&#39;王五&#39;,25,&#39;女&#39;,100),(NULL,&#39;赵六&#39;,26,&#39;女&#39;,90);<br><br>-- 按照性别进行分组，查询每组学生的总成绩。按照总成绩的升序排序<br>SELECT gender,SUM(score) getSum FROM student GROUP BY gender ORDER BY getSum ASC;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>创建存储过程语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 修改分隔符为$  （注意：创建存储过程之前修改分隔符为$）<br>DELIMITER $<br><br>-- 标准语法<br>CREATE PROCEDURE 存储过程名称(参数...)  -- procedure：[prəˈsi:dʒə(r)] 过程<br>BEGIN<br>	sql语句;  -- 注意：数据库不会认为这里是结束<br>END$  -- 注意：数据库认为这里才是结束<br><br>-- 修改分隔符为分号<br>DELIMITER ;  -- 注意：只有在存储过程中不能用;结束，既然存储过程都创建好了，我们就再改为以;结束<br></code></pre></div></td></tr></table></figure>

<ul>
<li>创建存储过程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 修改分隔符为$<br>DELIMITER $<br><br>-- 创建存储过程，封装分组查询学生总成绩的sql语句<br>CREATE PROCEDURE stu_group()<br>BEGIN<br>	-- 注意：我们这里是简单使用一些存储过程，所以只写了一句sql，不过即使只有一句sql，放到存储过程之后，可以重复使用<br>	SELECT gender,SUM(score) getSum FROM student GROUP BY gender ORDER BY getSum ASC;<br>END$<br><br>-- 修改分隔符为分号<br>DELIMITER ;<br></code></pre></div></td></tr></table></figure>

<h4 id="5-调用存储过程"><a href="#5-调用存储过程" class="headerlink" title="5. 调用存储过程"></a>5. 调用存储过程</h4><ul>
<li>调用存储过程语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>CALL 存储过程名称(实际参数);<br><br>-- 调用stu_group存储过程<br>CALL stu_group();<br></code></pre></div></td></tr></table></figure>

<h4 id="6-查看存储过程"><a href="#6-查看存储过程" class="headerlink" title="6. 查看存储过程"></a>6. 查看存储过程</h4><ul>
<li>查看存储过程语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 查询数据库中所有的存储过程 标准语法<br>SELECT * FROM mysql.proc WHERE db&#x3D;&#39;数据库名称&#39;;<br>-- 注意： proc：procedure<br>-- 理解： 相当于存储过程是存储在mysql.proc这个表中，这个表中有一个字段db，是当前存储过程所属的数据库<br></code></pre></div></td></tr></table></figure>

<h4 id="7-删除存储过程"><a href="#7-删除存储过程" class="headerlink" title="7. 删除存储过程"></a>7. 删除存储过程</h4><ul>
<li>删除存储过程语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法（注意： 语法中，中括号的内容是可选内容）<br>DROP PROCEDURE [IF EXISTS] 存储过程名称;  -- 注意： 中括号中的if exists ， 可写可不写<br><br>-- 删除stu_group存储过程<br>DROP PROCEDURE stu_group; -- 注意： 删除存储过程，不需要写小括号，调用的时候需要<br></code></pre></div></td></tr></table></figure>

<h4 id="8-存储过程语法"><a href="#8-存储过程语法" class="headerlink" title="8. 存储过程语法"></a>8. 存储过程语法</h4><h5 id="8-1-存储过程语法介绍"><a href="#8-1-存储过程语法介绍" class="headerlink" title="8.1 存储过程语法介绍"></a>8.1 存储过程语法介绍</h5><ul>
<li>存储过程是可以进行编程的。意味着可以使用变量、表达式、条件控制语句、循环语句等，来完成比较复杂的功能！</li>
</ul>
<h5 id="8-2-变量的使用"><a href="#8-2-变量的使用" class="headerlink" title="8.2 变量的使用"></a>8.2 变量的使用</h5><ul>
<li>定义变量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>DECLARE 变量名 数据类型 [DEFAULT 默认值];<br>-- 注意： DECLARE定义的是局部变量，只能用在BEGIN END范围之内<br>-- declare :  [dɪˈkleə(r)]  声明<br><br>-- 定义一个int类型变量、并赋默认值为10<br>DELIMITER $<br><br>CREATE PROCEDURE pro_test1()<br>BEGIN<br>	DECLARE num INT DEFAULT 10;   -- 定义变量<br>	SELECT num;                   -- 查询变量<br>END$<br><br>DELIMITER ;<br><br>-- 调用pro_test1存储过程<br>CALL pro_test1();<br></code></pre></div></td></tr></table></figure>

<ul>
<li>变量的赋值1</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>SET 变量名 &#x3D; 变量值;<br><br>-- 定义字符串类型变量，并赋值<br>DELIMITER $<br><br>CREATE PROCEDURE pro_test2()<br>BEGIN<br>	DECLARE NAME VARCHAR(10);   -- 定义变量<br>	SET NAME &#x3D; &#39;存储过程&#39;;       -- 为变量赋值<br>	SELECT NAME;                -- 查询变量<br>END$<br><br>DELIMITER ;<br><br>-- 调用pro_test2存储过程<br>CALL pro_test2();<br></code></pre></div></td></tr></table></figure>

<ul>
<li>变量的赋值2： 将查询结果输入到变量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>SELECT 列名 INTO 变量名 FROM 表名 [WHERE 条件]; -- into 输入<br><br>-- 定义两个int变量，用于存储男女同学的总分数<br>DELIMITER $<br><br>CREATE PROCEDURE pro_test3()<br>BEGIN<br>	DECLARE men,women INT;  -- 定义变量<br>	SELECT SUM(score) INTO men FROM student WHERE gender&#x3D;&#39;男&#39;;    -- 计算男同学总分数赋值给men<br>	SELECT SUM(score) INTO women FROM student WHERE gender&#x3D;&#39;女&#39;;  -- 计算女同学总分数赋值给women<br>	SELECT men,women;           -- 查询变量<br>END$<br><br>DELIMITER ;<br><br>-- 调用pro_test3存储过程<br>CALL pro_test3();<br></code></pre></div></td></tr></table></figure>

<h5 id="8-3-if语句的使用"><a href="#8-3-if语句的使用" class="headerlink" title="8.3 if语句的使用"></a>8.3 if语句的使用</h5><ul>
<li>标准语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>IF 判断条件1 THEN 执行的sql语句1;    -- 注意： then 然后， 如果满足添加，然后执行xx<br>[ELSEIF 判断条件2 THEN 执行的sql语句2;]<br>...<br>[ELSE 执行的sql语句n;]<br>END IF;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>案例演示</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">&#x2F;*<br>	定义一个int变量，用于存储班级总成绩<br>	定义一个varchar变量，用于存储分数描述<br>	根据总成绩判断：<br>		380分及以上    学习优秀<br>		320 ~ 380     学习不错<br>		320以下       学习一般<br>*&#x2F;<br>DELIMITER $<br><br>CREATE PROCEDURE pro_test4()<br>BEGIN<br>	-- 定义总分数变量<br>	DECLARE total INT;<br>	-- 定义分数描述变量<br>	DECLARE description VARCHAR(10);<br>	-- 为总分数变量赋值<br>	SELECT SUM(score) INTO total FROM student;<br>	-- 判断总分数<br>	IF total &gt;&#x3D; 380 THEN <br>		SET description &#x3D; &#39;学习优秀&#39;;<br>	ELSEIF total &gt;&#x3D; 320 AND total &lt; 380 THEN <br>		SET description &#x3D; &#39;学习不错&#39;;<br>	ELSE <br>		SET description &#x3D; &#39;学习一般&#39;;<br>	END IF;<br>	<br>	-- 查询总成绩和描述信息<br>	SELECT total,description;<br>END$<br><br>DELIMITER ;<br><br>-- 调用pro_test4存储过程<br>CALL pro_test4();<br></code></pre></div></td></tr></table></figure>

<h5 id="8-4-参数的传递"><a href="#8-4-参数的传递" class="headerlink" title="8.4 参数的传递"></a>8.4 参数的传递</h5><ul>
<li>参数传递的语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">DELIMITER $<br><br>-- 标准语法<br>CREATE PROCEDURE 存储过程名称([IN|OUT|INOUT] 参数名 数据类型)<br>BEGIN<br>	执行的sql语句;<br>END$<br>&#x2F;*<br>	IN:代表输入参数，需要由调用者传递实际数据。默认的<br>	OUT:代表输出参数，该参数可以作为返回值<br>	INOUT:代表既可以作为输入参数，也可以作为输出参数<br>*&#x2F;<br>DELIMITER ;<br></code></pre></div></td></tr></table></figure>

<ul>
<li><p>输入参数</p>
<ul>
<li>标准语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">DELIMITER $<br><br>-- 标准语法<br>CREATE PROCEDURE 存储过程名称(IN 参数名 数据类型)<br>BEGIN<br>	执行的sql语句;<br>END$<br><br>DELIMITER ;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>案例演示</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">&#x2F;*<br>	输入总成绩变量，代表学生总成绩<br>	定义一个varchar变量，用于存储分数描述<br>	根据总成绩判断：<br>		380分及以上  学习优秀<br>		320 ~ 380    学习不错<br>		320以下      学习一般<br>*&#x2F;<br>DELIMITER $<br><br>CREATE PROCEDURE pro_test5(IN total INT)<br>BEGIN<br>	-- 定义分数描述变量<br>	DECLARE description VARCHAR(10);<br>	-- 判断总分数<br>	IF total &gt;&#x3D; 380 THEN <br>		SET description &#x3D; &#39;学习优秀&#39;;<br>	ELSEIF total &gt;&#x3D; 320 AND total &lt; 380 THEN <br>		SET description &#x3D; &#39;学习不错&#39;;<br>	ELSE <br>		SET description &#x3D; &#39;学习一般&#39;;<br>	END IF;<br>	<br>	-- 查询总成绩和描述信息<br>	SELECT total,description;<br>END$<br><br>DELIMITER ;<br><br>-- 调用pro_test5存储过程<br>CALL pro_test5(390);<br>CALL pro_test5((SELECT SUM(score) FROM student));<br></code></pre></div></td></tr></table></figure></li>
<li><p>输出参数</p>
<ul>
<li>标准语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">DELIMITER $<br><br>-- 标准语法<br>CREATE PROCEDURE 存储过程名称(OUT 参数名 数据类型)<br>BEGIN<br>	执行的sql语句;<br>END$<br><br>DELIMITER ;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>案例演示</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">&#x2F;*<br>	输入总成绩变量，代表学生总成绩<br>	输出分数描述变量，代表学生总成绩的描述<br>	根据总成绩判断：<br>		380分及以上  学习优秀<br>		320 ~ 380    学习不错<br>		320以下      学习一般<br>*&#x2F;<br>DELIMITER $<br><br>CREATE PROCEDURE pro_test6(IN total INT,OUT description VARCHAR(10))<br>BEGIN<br>	-- 判断总分数<br>	IF total &gt;&#x3D; 380 THEN <br>		SET description &#x3D; &#39;学习优秀&#39;;<br>	ELSEIF total &gt;&#x3D; 320 AND total &lt; 380 THEN <br>		SET description &#x3D; &#39;学习不错&#39;;<br>	ELSE <br>		SET description &#x3D; &#39;学习一般&#39;;<br>	END IF;<br>END$<br><br>DELIMITER ;<br><br>-- 调用pro_test6存储过程<br>CALL pro_test6(310,@description); -- 注意： @变量名，定义一个会话变量，这个变量作为输出参数传递给存储过程，然后在存储过程中，进行赋值，最后可以通过select 进行查询变量的值<br><br>-- 查询总成绩描述<br>SELECT @description;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>小知识</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">@变量名:  这种变量要在变量名称前面加上“@”符号，叫做用户会话变量，代表整个会话过程他都是有作用的，这个类似于全局变量一样。<br><br>@@变量名: 这种在变量前加上 &quot;@@&quot; 符号, 叫做系统变量 <br>-- 读取 全局变量<br>SELECT @@global.sort_buffer_size;<br>-- 设置全局变量<br>SET @@global.sort_buffer_size &#x3D; 262144;<br></code></pre></div></td></tr></table></figure></li>
</ul>
<h5 id="8-5-case语句的使用（不讲解）"><a href="#8-5-case语句的使用（不讲解）" class="headerlink" title="8.5 case语句的使用（不讲解）"></a>8.5 case语句的使用（不讲解）</h5><ul>
<li>标准语法1</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>CASE 表达式<br>WHEN 值1 THEN 执行sql语句1;<br>[WHEN 值2 THEN 执行sql语句2;]<br>...<br>[ELSE 执行sql语句n;]<br>END CASE;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>标准语法2</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>CASE<br>WHEN 判断条件1 THEN 执行sql语句1;<br>[WHEN 判断条件2 THEN 执行sql语句2;]<br>...<br>[ELSE 执行sql语句n;]<br>END CASE;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>案例演示</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">&#x2F;*<br>	输入总成绩变量，代表学生总成绩<br>	定义一个varchar变量，用于存储分数描述<br>	根据总成绩判断：<br>		380分及以上  学习优秀<br>		320 ~ 380    学习不错<br>		320以下      学习一般<br>*&#x2F;<br>DELIMITER $<br><br>CREATE PROCEDURE pro_test7(IN total INT)<br>BEGIN<br>	-- 定义变量<br>	DECLARE description VARCHAR(10);<br>	-- 使用case判断<br>	CASE<br>	WHEN total &gt;&#x3D; 380 THEN<br>		SET description &#x3D; &#39;学习优秀&#39;;<br>	WHEN total &gt;&#x3D; 320 AND total &lt; 380 THEN<br>		SET description &#x3D; &#39;学习不错&#39;;<br>	ELSE <br>		SET description &#x3D; &#39;学习一般&#39;;<br>	END CASE;<br>	<br>	-- 查询分数描述信息<br>	SELECT description;<br>END$<br><br>DELIMITER ;<br><br>-- 调用pro_test7存储过程<br>CALL pro_test7(390);<br>CALL pro_test7((SELECT SUM(score) FROM student));<br></code></pre></div></td></tr></table></figure>

<h5 id="8-6-while循环"><a href="#8-6-while循环" class="headerlink" title="8.6 while循环"></a>8.6 while循环</h5><ul>
<li>标准语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>初始化语句;<br>WHILE 条件判断语句 DO<br>	循环体语句;<br>	条件控制语句;<br>END WHILE;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>案例演示</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">&#x2F;*<br>	计算1~100之间的偶数和<br>*&#x2F;<br>DELIMITER $<br><br>CREATE PROCEDURE pro_test8()<br>BEGIN<br>	-- 定义求和变量<br>	DECLARE result INT DEFAULT 0;<br>	-- 定义初始化变量<br>	DECLARE num INT DEFAULT 1;<br>	-- while循环<br>	WHILE num &lt;&#x3D; 100 DO<br>		-- 偶数判断<br>		IF num%2&#x3D;0 THEN<br>			SET result &#x3D; result + num; -- 累加<br>		END IF;<br>		<br>		-- 让num+1<br>		SET num &#x3D; num + 1;         <br>	END WHILE;<br>	<br>	-- 查询求和结果<br>	SELECT result;<br>END$<br><br>DELIMITER ;<br><br>-- 调用pro_test8存储过程<br>CALL pro_test8();<br></code></pre></div></td></tr></table></figure>

<h5 id="8-7-repeat循环-（不讲解）"><a href="#8-7-repeat循环-（不讲解）" class="headerlink" title="8.7 repeat循环 （不讲解）"></a>8.7 repeat循环 （不讲解）</h5><ul>
<li>标准语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>初始化语句;<br>REPEAT<br>	循环体语句;<br>	条件控制语句;<br>	UNTIL 条件判断语句<br>END REPEAT;<br><br>-- 注意：repeat循环是条件满足则停止。while循环是条件满足则执行<br></code></pre></div></td></tr></table></figure>

<ul>
<li>案例演示</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">&#x2F;*<br>	计算1~10之间的和<br>*&#x2F;<br>DELIMITER $<br><br>CREATE PROCEDURE pro_test9()<br>BEGIN<br>	-- 定义求和变量<br>	DECLARE result INT DEFAULT 0;<br>	-- 定义初始化变量<br>	DECLARE num INT DEFAULT 1;<br>	-- repeat循环<br>	REPEAT<br>		-- 累加<br>		SET result &#x3D; result + num;<br>		-- 让num+1<br>		SET num &#x3D; num + 1;<br>		<br>		-- 停止循环<br>		UNTIL num&gt;10<br>	END REPEAT;<br>	<br>	-- 查询求和结果<br>	SELECT result;<br>END$<br><br>DELIMITER ;<br><br>-- 调用pro_test9存储过程<br>CALL pro_test9();<br></code></pre></div></td></tr></table></figure>

<h5 id="8-8-loop循环-（不讲解）"><a href="#8-8-loop循环-（不讲解）" class="headerlink" title="8.8 loop循环 （不讲解）"></a>8.8 loop循环 （不讲解）</h5><ul>
<li>标准语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>初始化语句;<br>[循环名称:] LOOP<br>	条件判断语句<br>		[LEAVE 循环名称;]<br>	循环体语句;<br>	条件控制语句;<br>END LOOP 循环名称;<br><br>-- 注意：loop可以实现简单的循环，但是退出循环需要使用其他的语句来定义。我们可以使用leave语句完成！<br>--      如果不加退出循环的语句，那么就变成了死循环。<br></code></pre></div></td></tr></table></figure>

<ul>
<li>案例演示</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">&#x2F;*<br>	计算1~10之间的和<br>*&#x2F;<br>DELIMITER $<br><br>CREATE PROCEDURE pro_test10()<br>BEGIN<br>	-- 定义求和变量<br>	DECLARE result INT DEFAULT 0;<br>	-- 定义初始化变量<br>	DECLARE num INT DEFAULT 1;<br>	-- loop循环<br>	l:LOOP<br>		-- 条件成立，停止循环<br>		IF num &gt; 10 THEN<br>			LEAVE l;<br>		END IF;<br>	<br>		-- 累加<br>		SET result &#x3D; result + num;<br>		-- 让num+1<br>		SET num &#x3D; num + 1;<br>	END LOOP l;<br>	<br>	-- 查询求和结果<br>	SELECT result;<br>END$<br><br>DELIMITER ;<br><br>-- 调用pro_test10存储过程<br>CALL pro_test10();<br></code></pre></div></td></tr></table></figure>

<h5 id="8-9-游标-（游标）"><a href="#8-9-游标-（游标）" class="headerlink" title="8.9 游标 （游标）"></a>8.9 游标 （游标）</h5><ul>
<li><p>游标的概念 </p>
<ul>
<li>游标可以遍历返回的多行结果，每次拿到一整行数据</li>
<li>在存储过程和函数中可以使用游标对结果集进行循环的处理</li>
<li>简单来说游标就类似于集合的迭代器遍历</li>
<li>MySQL中的游标只能用在存储过程和函数中</li>
</ul>
</li>
<li><p>游标的语法</p>
<ul>
<li>创建游标</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>DECLARE 游标名称 CURSOR FOR 查询sql语句;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>打开游标</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>OPEN 游标名称;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>使用游标获取数据</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>FETCH 游标名称 INTO 变量名1,变量名2,...;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>关闭游标</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>CLOSE 游标名称;<br></code></pre></div></td></tr></table></figure></li>
<li><p>游标的基本使用</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 创建stu_score表<br>CREATE TABLE stu_score(<br>	id INT PRIMARY KEY AUTO_INCREMENT,<br>	score INT<br>);<br><br>&#x2F;*<br>	将student表中所有的成绩保存到stu_score表中<br>*&#x2F;<br>DELIMITER $<br><br>CREATE PROCEDURE pro_test11()<br>BEGIN<br>	-- 定义成绩变量<br>	DECLARE s_score INT;<br>	-- 创建游标,查询所有学生成绩数据<br>	DECLARE stu_result CURSOR FOR SELECT score FROM student;<br>	<br>	-- 开启游标<br>	OPEN stu_result;<br>	<br>	-- 使用游标，遍历结果,拿到第1行数据<br>	FETCH stu_result INTO s_score;<br>	-- 将数据保存到stu_score表中<br>	INSERT INTO stu_score VALUES (NULL,s_score);<br>	<br>	-- 使用游标，遍历结果,拿到第2行数据<br>	FETCH stu_result INTO s_score;<br>	-- 将数据保存到stu_score表中<br>	INSERT INTO stu_score VALUES (NULL,s_score);<br>	<br>	-- 使用游标，遍历结果,拿到第3行数据<br>	FETCH stu_result INTO s_score;<br>	-- 将数据保存到stu_score表中<br>	INSERT INTO stu_score VALUES (NULL,s_score);<br>	<br>	-- 使用游标，遍历结果,拿到第4行数据<br>	FETCH stu_result INTO s_score;<br>	-- 将数据保存到stu_score表中<br>	INSERT INTO stu_score VALUES (NULL,s_score);<br>	<br>	-- 关闭游标<br>	CLOSE stu_result;<br>END$<br><br>DELIMITER ;<br><br>-- 调用pro_test11存储过程<br>CALL pro_test11();<br><br>-- 查询stu_score表<br>SELECT * FROM stu_score;<br><br><br>-- &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>&#x2F;*<br>	出现的问题：<br>		student表中一共有4条数据，我们在游标遍历了4次，没有问题！<br>		但是在游标中多遍历几次呢？就会出现问题<br>*&#x2F;<br>DELIMITER $<br><br>CREATE PROCEDURE pro_test11()<br>BEGIN<br>	-- 定义成绩变量<br>	DECLARE s_score INT;<br>	-- 创建游标,查询所有学生成绩数据<br>	DECLARE stu_result CURSOR FOR SELECT score FROM student;<br>	<br>	-- 开启游标<br>	OPEN stu_result;<br>	<br>	-- 使用游标，遍历结果,拿到第1行数据<br>	FETCH stu_result INTO s_score;<br>	-- 将数据保存到stu_score表中<br>	INSERT INTO stu_score VALUES (NULL,s_score);<br>	<br>	-- 使用游标，遍历结果,拿到第2行数据<br>	FETCH stu_result INTO s_score;<br>	-- 将数据保存到stu_score表中<br>	INSERT INTO stu_score VALUES (NULL,s_score);<br>	<br>	-- 使用游标，遍历结果,拿到第3行数据<br>	FETCH stu_result INTO s_score;<br>	-- 将数据保存到stu_score表中<br>	INSERT INTO stu_score VALUES (NULL,s_score);<br>	<br>	-- 使用游标，遍历结果,拿到第4行数据<br>	FETCH stu_result INTO s_score;<br>	-- 将数据保存到stu_score表中<br>	INSERT INTO stu_score VALUES (NULL,s_score);<br>	<br>	-- 使用游标，遍历结果,拿到第5行数据<br>	FETCH stu_result INTO s_score;<br>	-- 将数据保存到stu_score表中<br>	INSERT INTO stu_score VALUES (NULL,s_score);<br>	<br>	-- 关闭游标<br>	CLOSE stu_result;<br>END$<br><br>DELIMITER ;<br><br>-- 调用pro_test11存储过程<br>CALL pro_test11();<br><br>-- 查询stu_score表,虽然数据正确，但是在执行存储过程时会报错<br>SELECT * FROM stu_score;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>游标的优化使用(配合循环使用)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">&#x2F;*<br>	当游标结束后，会触发游标结束事件。我们可以通过这一特性来完成循环操作<br>	加标记思想：<br>		1.定义一个变量，默认值为0(意味着有数据)<br>		2.当游标结束后，将变量值改为1(意味着没有数据了)<br>*&#x2F;<br>-- 1.定义一个变量，默认值为0(意味着有数据)<br>DECLARE flag INT DEFAULT 0;<br>-- 2.当游标结束后，将变量值改为1(意味着没有数据了)<br>DECLARE EXIT HANDLER FOR NOT FOUND SET flag &#x3D; 1;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">&#x2F;*<br>	将student表中所有的成绩保存到stu_score表中<br>*&#x2F;<br>DELIMITER $<br><br>CREATE PROCEDURE pro_test12()<br>BEGIN<br>	-- 定义成绩变量<br>	DECLARE s_score INT;<br>	-- 定义标记变量<br>	DECLARE flag INT DEFAULT 0;<br>	-- 创建游标，查询所有学生成绩数据<br>	DECLARE stu_result CURSOR FOR SELECT score FROM student;<br>	-- 游标结束后，将标记变量改为1<br>	DECLARE EXIT HANDLER FOR NOT FOUND SET flag &#x3D; 1;<br>	<br>	-- 开启游标<br>	OPEN stu_result;<br>	<br>	-- 循环使用游标<br>	REPEAT<br>		-- 使用游标，遍历结果,拿到数据<br>		FETCH stu_result INTO s_score;<br>		-- 将数据保存到stu_score表中<br>		INSERT INTO stu_score VALUES (NULL,s_score);<br>	UNTIL flag&#x3D;1<br>	END REPEAT;<br>	<br>	-- 关闭游标<br>	CLOSE stu_result;<br>END$<br><br>DELIMITER ;<br><br>-- 调用pro_test12存储过程<br>CALL pro_test12();<br><br>-- 查询stu_score表<br>SELECT * FROM stu_score;<br></code></pre></div></td></tr></table></figure>

<h4 id="9-存储过程的总结"><a href="#9-存储过程的总结" class="headerlink" title="9. 存储过程的总结"></a>9. 存储过程的总结</h4><ul>
<li>存储过程是 事先经过编译并存储在数据库中的一段 SQL 语句的集合。可以在数据库层面做一些业务处理</li>
<li>说白了存储过程其实就是将sql语句封装为方法，然后可以调用方法执行sql语句而已</li>
<li>存储过程的好处<ul>
<li>安全</li>
<li>高效</li>
<li>复用性强</li>
</ul>
</li>
</ul>
<h4 id="10-存储函数"><a href="#10-存储函数" class="headerlink" title="10. 存储函数"></a>10. 存储函数</h4><ul>
<li><p>存储函数和存储过程是非常相似的。存储函数可以做的事情，存储过程也可以做到！</p>
</li>
<li><p>存储函数有返回值，存储过程没有返回值(参数的out其实也相当于是返回数据了)</p>
</li>
<li><p>标准语法</p>
<ul>
<li>创建存储函数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">DELIMITER $<br><br>-- 标准语法<br>CREATE FUNCTION 函数名称([参数 数据类型])<br>RETURNS 返回值类型<br>BEGIN<br>	执行的sql语句;<br>	RETURN 结果;<br>END$<br><br>DELIMITER ;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>调用存储函数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>SELECT 函数名称(实际参数);  -- 调用存储函数，使用的是select，不是call<br></code></pre></div></td></tr></table></figure>

<ul>
<li>删除存储函数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>DROP FUNCTION 函数名称;<br></code></pre></div></td></tr></table></figure></li>
<li><p>案例演示</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">&#x2F;*<br>	定义存储函数，获取学生表中成绩大于95分的学生数量<br>*&#x2F;<br>DELIMITER $<br><br>CREATE FUNCTION fun_test1()<br>RETURNS INT<br>BEGIN<br>	-- 定义统计变量<br>	DECLARE result INT;<br>	-- 查询成绩大于95分的学生数量，给统计变量赋值<br>	SELECT COUNT(*) INTO result FROM student WHERE score &gt; 95;<br>	-- 返回统计结果<br>	RETURN result;<br>END$<br><br>DELIMITER ;<br><br>-- 调用fun_test1存储函数<br>SELECT fun_test1();<br></code></pre></div></td></tr></table></figure>

<h3 id="二、MySQL触发器"><a href="#二、MySQL触发器" class="headerlink" title="二、MySQL触发器"></a>二、MySQL触发器</h3><h4 id="1-触发器的概念"><a href="#1-触发器的概念" class="headerlink" title="1. 触发器的概念"></a>1. 触发器的概念</h4><ul>
<li>触发器是与表有关的数据库对象，可以在 insert/update/delete 之前或之后，触发并执行触发器中定义的SQL语句。触发器的这种特性可以协助应用在数据库端确保数据的完整性 、日志记录 、数据校验等操作 。</li>
<li>使用别名 NEW 和 OLD 来引用触发器中发生变化的记录内容，这与其他的数据库是相似的。现在触发器还只支持行级触发，不支持语句级触发。</li>
</ul>
<table>
<thead>
<tr>
<th>触发器类型</th>
<th>OLD的含义</th>
<th>NEW的含义</th>
</tr>
</thead>
<tbody><tr>
<td>INSERT 型触发器</td>
<td>无 (因为插入前状态无数据)</td>
<td>NEW 表示将要或者已经新增的数据</td>
</tr>
<tr>
<td>UPDATE 型触发器</td>
<td>OLD 表示修改之前的数据</td>
<td>NEW 表示将要或已经修改后的数据</td>
</tr>
<tr>
<td>DELETE 型触发器</td>
<td>OLD 表示将要或者已经删除的数据</td>
<td>无 (因为删除后状态无数据)</td>
</tr>
</tbody></table>
<ul>
<li><p>理解：触发器：一个功能执行之后，自动触发另一个功能执行</p>
</li>
<li><p>例子：触发器实现日志记录功能</p>
<p><img src="/2020/05/03/mysql03/img/%E8%A7%A6%E5%8F%91%E5%99%A8.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>插入王五，就会在log表中有一条insert操作的记录</li>
<li>更新李四，就会在log表中有一条update操作的记录</li>
<li>通过new关键字可以获取新的数据，通过old关键字可以获取旧的数据</li>
</ul>
</li>
</ul>
<h4 id="2-创建触发器"><a href="#2-创建触发器" class="headerlink" title="2. 创建触发器"></a>2. 创建触发器</h4><ul>
<li>标准语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">DELIMITER $<br><br>CREATE TRIGGER 触发器名称   -- Trigger：触发器<br>BEFORE|AFTER INSERT|UPDATE|DELETE  -- 之前|之后 插入|更新|删除（触发器类型）<br>ON 表名<br>[FOR EACH ROW]  -- 行级触发器<br>BEGIN<br>	触发器要执行的功能;<br>END$<br><br>DELIMITER ;<br></code></pre></div></td></tr></table></figure>

<ul>
<li><p>触发器演示。通过触发器记录账户表的数据变更日志。包含：增加、修改、删除</p>
<ul>
<li>创建账户表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 创建db9数据库<br>CREATE DATABASE db9;<br><br>-- 使用db9数据库<br>USE db9;<br><br>-- 创建账户表account<br>CREATE TABLE account(<br>	id INT PRIMARY KEY AUTO_INCREMENT,	-- 账户id<br>	NAME VARCHAR(20),					-- 姓名<br>	money DOUBLE						-- 余额<br>);<br>-- 添加数据<br>INSERT INTO account VALUES (NULL,&#39;张三&#39;,1000),(NULL,&#39;李四&#39;,2000);<br></code></pre></div></td></tr></table></figure>

<ul>
<li>创建日志表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 创建日志表account_log<br>CREATE TABLE account_log(<br>	id INT PRIMARY KEY AUTO_INCREMENT,	-- 日志id<br>	operation VARCHAR(20),				-- 操作类型 (insert update delete)<br>	operation_time DATETIME,			-- 操作时间<br>	operation_id INT,					-- 操作表的id<br>	operation_params VARCHAR(200)       -- 操作参数<br>);<br></code></pre></div></td></tr></table></figure>

<ul>
<li>创建INSERT触发器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 创建INSERT触发器<br>DELIMITER $<br><br>CREATE TRIGGER account_insert<br>AFTER INSERT<br>ON account<br>FOR EACH ROW<br>BEGIN<br>	INSERT INTO account_log VALUES (NULL,&#39;INSERT&#39;,NOW(),new.id,CONCAT(&#39;插入后&#123;id&#x3D;&#39;,new.id,&#39;,name&#x3D;&#39;,new.name,&#39;,money&#x3D;&#39;,new.money,&#39;&#125;&#39;));<br>	-- 注意： 因为我们创建的是insert触发器，所以应该是after，我们要获取新增之后的数据<br>	-- 那要获取新增之后的数据，也就是新数据，所以通过new关键字获取<br>	-- CONCAT() 字符串拼接,concat:concatenate 连接<br>END$<br><br>DELIMITER ;<br><br>-- 向account表添加记录<br>INSERT INTO account VALUES (NULL,&#39;王五&#39;,3000);<br><br>-- 查询account表<br>SELECT * FROM account;<br><br>-- 查询日志表<br>SELECT * FROM account_log;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>创建UPDATE触发器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 创建UPDATE触发器<br>DELIMITER $<br><br>CREATE TRIGGER account_update<br>AFTER UPDATE<br>ON account<br>FOR EACH ROW<br>BEGIN<br>	INSERT INTO account_log VALUES (NULL,&#39;UPDATE&#39;,NOW(),new.id,CONCAT(&#39;修改前&#123;id&#x3D;&#39;,old.id,&#39;,name&#x3D;&#39;,old.name,&#39;,money&#x3D;&#39;,old.money,&#39;&#125;&#39;,&#39;修改后&#123;id&#x3D;&#39;,new.id,&#39;,name&#x3D;&#39;,new.name,&#39;,money&#x3D;&#39;,new.money,&#39;&#125;&#39;));<br>	-- 注意：修改数据，新旧数据都需要保存，所以需要通过new和old获取新旧数据<br>END$<br><br>DELIMITER ;<br><br>-- 修改account表<br>UPDATE account SET money&#x3D;3500 WHERE id&#x3D;3;<br><br>-- 查询account表<br>SELECT * FROM account;<br><br>-- 查询日志表<br>SELECT * FROM account_log;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>创建DELETE触发器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 创建DELETE触发器<br>DELIMITER $<br><br>CREATE TRIGGER account_delete<br>AFTER DELETE<br>ON account<br>FOR EACH ROW<br>BEGIN<br>	INSERT INTO account_log VALUES (NULL,&#39;DELETE&#39;,NOW(),old.id,CONCAT(&#39;删除前&#123;id&#x3D;&#39;,old.id,&#39;,name&#x3D;&#39;,old.name,&#39;,money&#x3D;&#39;,old.money,&#39;&#125;&#39;));<br>	-- 注意： 删除的数据需要记录，通过old获取删除之前的旧数据<br>END$<br><br>DELIMITER ;<br><br>-- 删除account表数据<br>DELETE FROM account WHERE id&#x3D;3;<br><br>-- 查询account表<br>SELECT * FROM account;<br><br>-- 查询日志表<br>SELECT * FROM account_log;<br></code></pre></div></td></tr></table></figure></li>
</ul>
<h4 id="3-查看触发器"><a href="#3-查看触发器" class="headerlink" title="3. 查看触发器"></a>3. 查看触发器</h4><figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>SHOW TRIGGERS;  -- 查看触发器是show，显示，不是select ， 与 查看所有数据库，表的语句一样：show databases，show tables<br><br>-- 查看触发器<br>SHOW TRIGGERS;<br></code></pre></div></td></tr></table></figure>

<h4 id="4-删除触发器"><a href="#4-删除触发器" class="headerlink" title="4. 删除触发器"></a>4. 删除触发器</h4><figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>DROP TRIGGER 触发器名称;<br><br>-- 删除DELETE触发器<br>DROP TRIGGER account_delete;<br></code></pre></div></td></tr></table></figure>

<h4 id="5-触发器的总结"><a href="#5-触发器的总结" class="headerlink" title="5. 触发器的总结"></a>5. 触发器的总结</h4><ul>
<li>触发器是与表有关的数据库对象</li>
<li>可以在 insert/update/delete 之前或之后，触发并执行触发器中定义的SQL语句</li>
<li>触发器的这种特性可以协助应用在数据库端确保数据的完整性 、日志记录 、数据校验等操作 </li>
<li>使用别名 NEW 和 OLD 来引用触发器中发生变化的记录内容</li>
</ul>
<h3 id="三、MySQL事务"><a href="#三、MySQL事务" class="headerlink" title="三、MySQL事务"></a>三、MySQL事务</h3><h4 id="1-事务的概念"><a href="#1-事务的概念" class="headerlink" title="1. 事务的概念"></a>1. 事务的概念</h4><ul>
<li><p>一条或多条 SQL 语句组成一个执行单元，其特点是这个单元要么同时成功要么同时失败，单元中的每条 SQL 语句都相互依赖，形成一个整体</p>
</li>
<li><p>如果某条 SQL 语句执行失败或者出现错误，那么整个单元就会回滚，撤回到事务最初的状态，</p>
</li>
<li><p>如果单元中所有的 SQL 语句都执行成功，则事务就顺利执行</p>
</li>
<li><p>很多逻辑是由多个sql语句组成的，而且还需要保证这多个sql语句都得同时执行成功</p>
</li>
<li><p>比如：银行转账</p>
<p><img src="/2020/05/03/mysql03/img/%E4%BA%8B%E5%8A%A1%E4%BB%8B%E7%BB%8D.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>如果第一条sql语句执行成功，但是由于某些原因第二条sql语句执行失败了</li>
<li>这时候张三就会莫名其妙的少了500块钱</li>
<li>这种事情，在银行是不会发生的</li>
<li>那银行如何保证都成功呢？通过事务</li>
</ul>
</li>
</ul>
<h4 id="2-事务的数据准备"><a href="#2-事务的数据准备" class="headerlink" title="2. 事务的数据准备"></a>2. 事务的数据准备</h4><figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 创建db10数据库<br>CREATE DATABASE db10;<br><br>-- 使用db10数据库<br>USE db10;<br><br>-- 创建账户表<br>CREATE TABLE account(<br>	id INT PRIMARY KEY AUTO_INCREMENT,	-- 账户id<br>	NAME VARCHAR(20),			-- 账户名称<br>	money DOUBLE				-- 账户余额<br>);<br>-- 添加数据<br>INSERT INTO account VALUES (NULL,&#39;张三&#39;,1000),(NULL,&#39;李四&#39;,1000);<br></code></pre></div></td></tr></table></figure>

<h4 id="3-未管理事务演示"><a href="#3-未管理事务演示" class="headerlink" title="3. 未管理事务演示"></a>3. 未管理事务演示</h4><figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 张三给李四转账500元<br>-- 1.张三账户-500<br>UPDATE account SET money&#x3D;money-500 WHERE NAME&#x3D;&#39;张三&#39;;<br>-- 2.李四账户+500<br>出错了... -- 这里因为没有添加注释，中文执行肯定报错<br>UPDATE account SET money&#x3D;money+500 WHERE NAME&#x3D;&#39;李四&#39;;<br><br>-- 该场景下，这两条sql语句要么同时成功，要么同时失败。就需要被事务所管理！<br></code></pre></div></td></tr></table></figure>

<h4 id="4-管理事务演示"><a href="#4-管理事务演示" class="headerlink" title="4. 管理事务演示"></a>4. 管理事务演示</h4><ul>
<li>操作事务的三个步骤<ol>
<li>开启事务：记录回滚点，并通知服务器，将要执行一组操作，要么同时成功、要么同时失败</li>
<li>执行sql语句：执行具体的一条或多条sql语句</li>
<li>结束事务(提交|回滚)<ul>
<li>提交：没出现问题，数据进行更新</li>
<li>回滚：出现问题，数据恢复到开启事务时的状态</li>
</ul>
</li>
</ol>
</li>
<li>开启事务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>START TRANSACTION; -- Transaction：[trænˈzækʃn] 事务<br></code></pre></div></td></tr></table></figure>

<ul>
<li>回滚事务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>ROLLBACK;  -- rollback：反转<br></code></pre></div></td></tr></table></figure>

<ul>
<li>提交事务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>COMMIT;  -- commit：提交<br></code></pre></div></td></tr></table></figure>

<ul>
<li>管理事务演示</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 开启事务<br>START TRANSACTION;<br><br>-- 张三给李四转账500元<br>-- 1.张三账户-500<br>UPDATE account SET money&#x3D;money-500 WHERE NAME&#x3D;&#39;张三&#39;;<br>-- 2.李四账户+500<br>-- 出错了...<br>UPDATE account SET money&#x3D;money+500 WHERE NAME&#x3D;&#39;李四&#39;;<br><br>-- 回滚事务(出现问题)<br>ROLLBACK;<br><br>-- 提交事务(没出现问题)<br>COMMIT;<br></code></pre></div></td></tr></table></figure>

<h4 id="5-事务的提交方式"><a href="#5-事务的提交方式" class="headerlink" title="5. 事务的提交方式"></a>5. 事务的提交方式</h4><ul>
<li><p>提交方式</p>
<ul>
<li>自动提交(MySQL默认为自动提交)</li>
<li>手动提交</li>
</ul>
</li>
<li><p>修改提交方式</p>
<ul>
<li>查看提交方式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>SELECT @@AUTOCOMMIT;  -- 1代表自动提交    0代表手动提交<br>-- 注意：@@autocommit是一个系统变量<br></code></pre></div></td></tr></table></figure>

<ul>
<li>修改提交方式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>SET @@AUTOCOMMIT&#x3D;数字;<br><br>-- 修改为手动提交<br>SET @@AUTOCOMMIT&#x3D;0;<br><br>-- 查看提交方式<br>SELECT @@AUTOCOMMIT;<br></code></pre></div></td></tr></table></figure>

<ul>
<li><p>如果改为收到提交，那么所有的增删改sql语句，都需要自己执行commit才可以</p>
<figure class="highlight sql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sql">UPDATE account <span class="hljs-keyword">SET</span> money<span class="hljs-operator">=</span><span class="hljs-number">2000</span> <span class="hljs-keyword">WHERE</span> NAME<span class="hljs-operator">=</span><span class="hljs-string">&#x27;张三&#x27;</span>;<br><span class="hljs-comment">-- 执行完之后，查询表中数据，发现已经是2000了，其实这个数据是临时的数据，退出sqlyog再次进入就会恢复</span><br><span class="hljs-comment">-- 只有执行过commit才可以</span><br><span class="hljs-keyword">commit</span>;<br></code></pre></div></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="6-事务的四大特征-ACID"><a href="#6-事务的四大特征-ACID" class="headerlink" title="6. 事务的四大特征(ACID)"></a>6. 事务的四大特征(ACID)</h4><ul>
<li>原子性(atomicity)<ul>
<li>原子性是指事务包含的所有操作要么全部成功，要么全部失败回滚，因此事务的操作如果成功就必须要完全应用到数据库，如果操作失败则不能对数据库有任何影响</li>
</ul>
</li>
<li>一致性(consistency)<ul>
<li>一致性是指事务必须使数据库从一个一致性状态变换到另一个一致性状态，也就是说一个事务执行之前和执行之后都必须处于一致性状态</li>
<li>拿转账来说，假设张三和李四两者的钱加起来一共是2000，那么不管A和B之间如何转账，转几次账，事务结束后两个用户的钱相加起来应该还得是2000，这就是事务的一致性</li>
</ul>
</li>
<li>隔离性(isolcation)<ul>
<li>隔离性是当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间要相互隔离</li>
</ul>
</li>
<li>持久性(durability)<ul>
<li>持久性是指一个事务一旦被提交了，那么对数据库中的数据的改变就是永久性的，即便是在数据库系统遇到故障的情况下也不会丢失提交事务的操作</li>
</ul>
</li>
</ul>
<h4 id="7-事务的隔离级别"><a href="#7-事务的隔离级别" class="headerlink" title="7. 事务的隔离级别"></a>7. 事务的隔离级别</h4><ul>
<li>隔离级别的概念<ul>
<li>多个客户端操作时 ,各个客户端的事务之间应该是隔离的，相互独立的 , 不受影响的。</li>
<li>而如果多个事务操作同一批数据时，则需要设置不同的隔离级别 , 否则就会产生问题 。</li>
<li>我们先来了解一下四种隔离级别的名称 , 再来看看可能出现的问题</li>
</ul>
</li>
<li>四种隔离级别</li>
</ul>
<table>
<thead>
<tr>
<th>1</th>
<th>读未提交</th>
<th>read uncommitted</th>
</tr>
</thead>
<tbody><tr>
<td><strong>2</strong></td>
<td><strong>读已提交</strong></td>
<td><strong>read committed</strong></td>
</tr>
<tr>
<td><strong>3</strong></td>
<td><strong>可重复读(mysql  默认的)</strong></td>
<td><strong>repeatable read</strong></td>
</tr>
<tr>
<td><strong>4</strong></td>
<td><strong>串行化</strong></td>
<td><strong>serializable</strong></td>
</tr>
</tbody></table>
<ul>
<li>可能引发的问题</li>
</ul>
<table>
<thead>
<tr>
<th>问题</th>
<th>现象</th>
</tr>
</thead>
<tbody><tr>
<td><strong>脏读</strong></td>
<td><strong>是指在一个事务处理过程中读取了另一个未提交的事务中的数据 , 导致两次查询结果不一致</strong></td>
</tr>
<tr>
<td><strong>不可重复读</strong></td>
<td><strong>是指在一个事务处理过程中读取了另一个事务中修改并已提交的数据, 导致两次查询结果不一致</strong></td>
</tr>
<tr>
<td><strong>幻读</strong></td>
<td><strong>select 某记录是否存在，不存在，准备插入此记录，但执行 insert 时发现此记录已存在，无法插入。或查询数据不存在执行delete删除，却发现删除成功</strong></td>
</tr>
</tbody></table>
<ul>
<li>查询数据库隔离级别</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>SELECT @@TX_ISOLATION;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>修改数据库隔离级别</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>SET GLOBAL TRANSACTION ISOLATION LEVEL 级别字符串;  -- isolation ： [ˌaɪsəˈleɪʃn] 隔离<br><br>-- 修改数据库隔离级别为read uncommitted<br>SET GLOBAL TRANSACTION ISOLATION LEVEL read uncommitted;<br><br>-- 查看隔离级别<br>SELECT @@TX_ISOLATION;   -- 修改后需要断开连接重新开<br></code></pre></div></td></tr></table></figure>

<h4 id="8-事务隔离级别演示"><a href="#8-事务隔离级别演示" class="headerlink" title="8. 事务隔离级别演示"></a>8. 事务隔离级别演示</h4><ul>
<li><p>脏读的问题</p>
<ul>
<li>窗口1</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 查询账户表<br>select * from account;<br><br>-- 设置隔离级别为read uncommitted  (注意：级别为读未提交，会造成脏读问题)<br>set global transaction isolation level read uncommitted;<br><br>-- 开启事务  （窗口2也执行此sql开启事务）<br>start transaction;<br><br>-- 转账<br>update account set money &#x3D; money - 500 where id &#x3D; 1;<br>update account set money &#x3D; money + 500 where id &#x3D; 2;<br><br>-- 窗口2查询转账结果 ,出现脏读(查询到其他事务未提交的数据)<br><br>-- 窗口2查看转账结果后，执行回滚<br>rollback;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>窗口2 （再开一个sqlyog连接到数据库）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 查询隔离级别<br>select @@tx_isolation;<br><br>-- 开启事务<br>start transaction;<br><br>-- 查询账户表<br>select * from account;<br></code></pre></div></td></tr></table></figure></li>
<li><p>解决脏读的问题和演示不可重复读的问题</p>
<ul>
<li>窗口1</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 设置隔离级别为read committed  （注意： 级别为读已提交，可以解决脏读问题）<br>set global transaction isolation level read committed;<br><br>-- 开启事务 （窗口2也执行此sql开启事务）<br>start transaction;<br><br>-- 转账<br>update account set money &#x3D; money - 500 where id &#x3D; 1;<br>update account set money &#x3D; money + 500 where id &#x3D; 2;<br><br>-- 窗口2查看转账结果，并没有发生变化(脏读问题被解决了)<br><br>-- 执行提交事务。<br>commit;<br><br>-- 窗口2查看转账结果，数据发生了变化(出现了不可重复读的问题，读取到其他事务已提交的数据)<br>-- 注意： 在窗口2中查询两次，结果数据不一样，这就是不可重复读<br>-- 其实这不是问题，正常现象就应该是如此<br>-- 老师举的例子，小王上午查询当年度的营收是100w，下午老板查询是80w，然后出现了出入，其实这也是正常的，因为数据一直在变化，如果出现这种情况，小王完全可以说，我统计的是某个时间点之前的营收。<br></code></pre></div></td></tr></table></figure>

<ul>
<li>窗口2</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 查询隔离级别（更改过隔离级别，最好重新开启窗口2，然后查询隔离级别）<br>select @@tx_isolation;<br><br>-- 开启事务<br>start transaction;<br><br>-- 查询账户表<br>select * from account;<br></code></pre></div></td></tr></table></figure></li>
<li><p>解决不可重复读的问题</p>
<ul>
<li>窗口1</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 设置隔离级别为repeatable read<br>set global transaction isolation level repeatable read;<br><br>-- 开启事务（窗口2也执行此sql开启事务）<br>start transaction;<br><br>-- 转账<br>update account set money &#x3D; money - 500 where id &#x3D; 1;<br>update account set money &#x3D; money + 500 where id &#x3D; 2;<br><br>-- 窗口2查看转账结果，并没有发生变化<br><br>-- 执行提交事务<br>commit;<br><br>-- 这个时候窗口2只要还在上次事务中，看到的结果都是相同的。只有窗口2结束事务，才能看到变化(不可重复读的问题被解决)<br>-- 什么情况会使用可重复读？可重复读的应用场景：<br>-- 某员工上午开始做一个数据采样，这个工作非常耗费时间，需要花费一天的时间，<br>-- 上午做了一半，到中午他去吃饭了，下午回来，继续往下进行的时候，发现数据对不上了（有人修改了数据），<br>-- 他还得重新开始<br>-- 这种情况下，他只是要做一个数据采样，唯一需要的就是，在做这件工作的时候，从开始到结束数据不能变化，这时候就需要可重复读（别人修改数据，我也不需要知道）。<br></code></pre></div></td></tr></table></figure>

<ul>
<li>窗口2</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 查询隔离级别<br>select @@tx_isolation;<br><br>-- 开启事务<br>start transaction;<br><br>-- 查询账户表<br>select * from account;<br><br>-- 提交事务<br>commit;<br><br>-- 查询账户表<br>select * from account;<br></code></pre></div></td></tr></table></figure></li>
<li><p>幻读的问题和解决</p>
<ul>
<li>窗口1</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 设置隔离级别为repeatable read<br>set global transaction isolation level repeatable read;<br><br>-- 开启事务 （窗口2也开启事务）<br>start transaction;<br><br>-- 添加一条记录<br>INSERT INTO account VALUES (3,&#39;王五&#39;,1500);<br><br>-- 查询账户表，本窗口可以查看到id为3的结果<br>SELECT * FROM account;<br>-- 窗口2查询账户表，查询不到新添加的id为3的记录<br>-- 窗口2，添加id为3的一条数据，发现添加失败 （执行完sql，发现左上角一直转圈圈，卡死了）<br><br>-- 提交事务   <br>COMMIT;<br>-- 窗口1提交过事务，窗口2立马就报错<br>-- 只有等窗口2提交过事务，再次查询，才会发现id为3的数据已经存在<br>-- 之前明明没有，现在却出现了，好像幻觉一样<br></code></pre></div></td></tr></table></figure>

<ul>
<li>窗口2</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 查询隔离级别<br>select @@tx_isolation;<br><br>-- 开启事务<br>start transaction;<br><br>-- 查询账户表，查询不到新添加的id为3的记录<br>select * from account;<br><br>-- 添加id为3的一条数据，发现添加失败。出现了幻读<br>INSERT INTO account VALUES (3,&#39;测试&#39;,200);<br><br>-- 提交事务<br>COMMIT;<br><br>-- 查询账户表，查询到了新添加的id为3的记录<br>select * from account;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>解决幻读的问题</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">&#x2F;*<br>	窗口1<br>*&#x2F;<br>-- 设置隔离级别为serializable （这个级别会解决所有的问题，但是效率低）<br>set global transaction isolation level serializable;<br><br>-- 开启事务 <br>start transaction;<br><br>-- 添加一条记录<br>INSERT INTO account VALUES (4,&#39;赵六&#39;,1600);<br><br>-- 查询账户表，本窗口可以查看到id为4的结果<br>SELECT * FROM account;<br><br>-- 窗口2查询账户表，发现查询语句无法执行，数据表被锁住（左上角转圈）！只有窗口1提交事务后，才可以继续操作<br><br>-- 提交事务<br>COMMIT;<br><br>-- 窗口1提交过事务，窗口2才会出现查询的数据<br>-- 发现有id为4的数据，就不会再插入id为4的数据<br><br><br>&#x2F;*<br>	窗口2<br>*&#x2F;<br>-- 查询隔离级别<br>select @@tx_isolation;<br><br>-- 开启事务<br>start transaction;<br><br>-- 查询账户表，发现查询语句无法执行，数据表被锁住！只有窗口1提交事务后，才可以继续操作<br>select * from account;<br><br>-- 添加id为4的一条数据，发现已经存在了，就不会再添加了！幻读的问题被解决<br>INSERT INTO account VALUES (4,&#39;测试&#39;,200);<br><br>-- 提交事务<br>COMMIT;<br></code></pre></div></td></tr></table></figure></li>
</ul>
<h4 id="9-隔离级别总结"><a href="#9-隔离级别总结" class="headerlink" title="9. 隔离级别总结"></a>9. 隔离级别总结</h4><table>
<thead>
<tr>
<th></th>
<th>隔离级别</th>
<th>名称</th>
<th>出现脏读</th>
<th>出现不可重复读</th>
<th>出现幻读</th>
<th>数据库默认隔离级别</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td><strong>read uncommitted</strong></td>
<td>读未提交</td>
<td>是</td>
<td>是</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td><strong>read committed</strong></td>
<td>读已提交</td>
<td>否</td>
<td>是</td>
<td>是</td>
<td>Oracle / SQL Server</td>
</tr>
<tr>
<td>3</td>
<td><strong>repeatable read</strong></td>
<td>可重复读</td>
<td>否</td>
<td>否</td>
<td>是</td>
<td>MySQL</td>
</tr>
<tr>
<td>4</td>
<td>**serializable **</td>
<td>串行化</td>
<td>否</td>
<td>否</td>
<td>否</td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>注意：隔离级别从小到大安全性越来越高，但是效率越来越低 , 所以不建议使用READ UNCOMMITTED 和 SERIALIZABLE 隔离级别.</p>
</blockquote>
<h4 id="10-事务的总结"><a href="#10-事务的总结" class="headerlink" title="10. 事务的总结"></a>10. 事务的总结</h4><ul>
<li>一条或多条 SQL 语句组成一个执行单元，其特点是这个单元要么同时成功要么同时失败。例如转账操作</li>
<li>开启事务：start transaction;</li>
<li>回滚事务：rollback;</li>
<li>提交事务：commit;</li>
<li>事务四大特征<ul>
<li>原子性</li>
<li>持久性</li>
<li>隔离性</li>
<li>一致性</li>
</ul>
</li>
<li>事务的隔离级别<ul>
<li>read uncommitted(读未提交)</li>
<li>read committed (读已提交)</li>
<li>repeatable read (可重复读)</li>
<li>serializable (串行化)</li>
</ul>
</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/MySQL/">MySQL</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/MySQL/">MySQL</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/05/04/jdbc01/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">JDBC-01</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/05/03/Javaweb03/">
                        <span class="hidden-mobile">Request&Response</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.lazyComments('valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function () {
        new Valine({
          el: "#valine",
          app_id: "7FicXKczRMSUD3slGCpiLLto-gzGzoHsz",
          app_key: "L7N1wkygdm2UHsrq5DHTuMMk",
          placeholder: "说点什么",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: true,
          recordIP: true,
          serverURLs: "https://7ficxkcz.lc-cn-n1-shared.com",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the
    <a target="_blank" href="https://valine.js.org" rel="nofollow noopener noopener">comments powered by Valine.</a>
  </noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <a target="_blank" href="https://www.12377.cn/" rel="nofollow noopener noopener">中央网信办（国家互联网信息办公室）违法和不良信息举报中心</a>

  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        京ICP证123456号
      </a>
    </span>
    
      
        <span>
          <a
            href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
            rel="nofollow noopener"
            class="beian-police"
            target="_blank"
          >
            
              <span style="visibility: hidden; width: 0">|</span>
              <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
            
            <span>京公网安备12345678号</span>
          </a>
        </span>
      
    
  </div>


  
  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>


  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-svg.js" ></script>

  








  

  

  

  

  
    <!-- 51.la Analytics -->
    <script defer type="text/javascript" src="//js.users.51.la/21111747.js"></script>
  

  




  
<script src="/js/caidai.js"></script>
<script src="/js/dianjichuzi.js"></script>



<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>

  <script type="text/javascript" src="//js.users.51.la/21111747.js"></script>
</body>
</html>
