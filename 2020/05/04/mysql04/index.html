

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="nitto">
  <meta name="keywords" content="">
  
  <title>MySQL高级-04 - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/toubudaziji.css">
<link rel="stylesheet" href="/css/gundongtiao.css">
<link rel="stylesheet" href="/css/shubiao.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"zfqwb.github.io","root":"/","version":"1.8.9","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":21111747,"cnzz":null,"leancloud":{"app_id":"bMWk1sw4iFwEPTeRxqFOkxvq-gzGzoHsz","app_key":"sDMo4aGFa1dFrXYs2oXkNaVY","server_url":"https://bmwk1sw4.lc-cn-n1-shared.com"}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  <meta name="baidu-site-verification" content="code-vbtyv0liY1" />
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>nitto</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="MySQL高级-04">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-05-04 19:34" pubdate>
        2020年5月4日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      13.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      163
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">MySQL高级-04</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2 个月前
                
              </p>
            
            <div class="markdown-body">
              <h3 id="一、MySQL存储引擎"><a href="#一、MySQL存储引擎" class="headerlink" title="一、MySQL存储引擎"></a>一、MySQL存储引擎</h3><h4 id="1-MySQL体系结构"><a href="#1-MySQL体系结构" class="headerlink" title="1. MySQL体系结构"></a>1. MySQL体系结构</h4><ul>
<li><p>体系结构的概念</p>
<ul>
<li>任何一套系统当中，每个部件都能起到一定的作用！</li>
</ul>
</li>
<li><p>MySQL的体系结构</p>
</li>
</ul>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/02.png" srcset="/img/loading.gif" lazyload alt="02"></p>
<ul>
<li>体系结构详解<ul>
<li>客户端连接<ul>
<li>支持接口：支持的客户端连接，例如C、Java、PHP等语言来连接MySQL数据库</li>
</ul>
</li>
<li>第一层：网络连接层<ul>
<li>连接池：管理、缓冲用户的连接，线程处理等需要缓存的需求。</li>
<li>例如：当客户端发送一个请求连接，会从连接池中获取一个连接进行使用。</li>
</ul>
</li>
<li>第二层：核心服务层<ul>
<li>管理服务和工具：系统的管理和控制工具，例如备份恢复、复制、集群等。 </li>
<li>SQL接口：接受SQL命令，并且返回查询结果。</li>
<li>查询解析器：验证和解析SQL命令，例如过滤条件、语法结构等。 </li>
<li>查询优化器：在执行查询之前，使用默认的一套优化机制进行优化sql语句</li>
<li>缓存：如果缓存当中有想查询的数据，则直接将缓存中的数据返回。没有的话再重新查询！</li>
</ul>
</li>
<li>第三层：存储引擎层<ul>
<li>插件式存储引擎：管理和操作数据的一种机制，包括(存储数据、如何更新、查询数据等)</li>
</ul>
</li>
<li>第四层：系统文件层<ul>
<li>文件系统：配置文件、数据文件、日志文件、错误文件、二进制文件等等的保存</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="2-MySQL存储引擎"><a href="#2-MySQL存储引擎" class="headerlink" title="2. MySQL存储引擎"></a>2. MySQL存储引擎</h4><ul>
<li><p>引擎的概念</p>
<ul>
<li><p>生活中，引擎就是整个机器运行的核心，不同的引擎具备不同的功能。</p>
<p><img src="/2020/05/04/mysql04/img/%E5%BC%95%E6%93%8E.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>上图中的不同设备需要装备不同的引擎</li>
</ul>
</li>
</ul>
</li>
<li><p>MySQL存储引擎的概念</p>
<ul>
<li>MySQL数据库使用不同的机制存取表文件 , 机制的差别在于不同的存储方式、索引技巧、锁定水平以及广泛的不同的功能和能力，在MySQL中 , 将这些不同的技术及配套的功能称为<strong>存储引擎</strong></li>
<li>在关系型数据库中数据的存储是以表的形式存进行储的，所以存储引擎也可以称为<strong>表类型</strong>（即存储和操作此表的类型）。</li>
<li>Oracle , SqlServer等数据库只有一种存储引擎 , 而MySQL针对不同的需求, 配置MySQL的不同的存储引擎 , 就会让数据库采取了不同的处理数据的方式和扩展功能。</li>
<li>通过选择不同的引擎 ,能够获取最佳的方案 ,  也能够获得额外的速度或者功能，提高程序的整体效果。所以了解引擎的特性 , 才能贴合我们的需求 , 更好的发挥数据库的性能。</li>
</ul>
</li>
<li><p>MySQL支持的存储引擎</p>
<ul>
<li>MySQL5.7支持的引擎包括：InnoDB、MyISAM、MEMORY、Archive、Federate、CSV、BLACKHOLE等</li>
<li>其中较为常用的有三种：InnoDB、MyISAM、MEMORY</li>
<li>最常用的是InnoDB</li>
</ul>
</li>
</ul>
<h4 id="3-常用引擎的特性对比"><a href="#3-常用引擎的特性对比" class="headerlink" title="3. 常用引擎的特性对比"></a>3. 常用引擎的特性对比</h4><ul>
<li>常用的存储引擎<ul>
<li>MyISAM存储引擎<ul>
<li>访问快,不支持事务和外键。表结构保存在.frm文件中，表数据保存在.MYD文件中，索引保存在.MYI文件中。</li>
</ul>
</li>
<li>InnoDB存储引擎 (MySQL5.5版本后默认的存储引擎) <ul>
<li>支持事务 ,占用磁盘空间大 ,支持并发控制。表结构保存在.frm文件中，如果是共享表空间，数据和索引保存在 innodb_data_home_dir 和 innodb_data_file_path定义的表空间中，可以是多个文件。如果是多表空间存储，每个表的数据和索引单独保存在 .ibd 中。</li>
</ul>
</li>
<li>MEMORY存储引擎<ul>
<li>内存存储 , 速度快 ,不安全 ,适合小量快速访问的数据。表结构保存在.frm中。</li>
<li>内存断电丢失，所以不安全</li>
</ul>
</li>
</ul>
</li>
<li>特性对比</li>
</ul>
<table>
<thead>
<tr>
<th>特性</th>
<th>MyISAM</th>
<th>InnoDB</th>
<th>MEMORY</th>
</tr>
</thead>
<tbody><tr>
<td>存储限制</td>
<td>有(平台对文件系统大小的限制)</td>
<td>64TB</td>
<td>有(平台的内存限制)</td>
</tr>
<tr>
<td><strong>事务安全</strong></td>
<td><strong>不支持</strong></td>
<td><strong>支持</strong></td>
<td><strong>不支持</strong></td>
</tr>
<tr>
<td><strong>锁机制</strong></td>
<td><strong>表锁</strong></td>
<td><strong>表锁/行锁</strong></td>
<td><strong>表锁</strong></td>
</tr>
<tr>
<td>B+Tree索引</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>哈希索引</td>
<td>不支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>全文索引</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td><strong>集群索引</strong></td>
<td><strong>不支持</strong></td>
<td><strong>支持</strong></td>
<td><strong>不支持</strong></td>
</tr>
<tr>
<td>数据索引</td>
<td>不支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>数据缓存</td>
<td>不支持</td>
<td>支持</td>
<td>N/A</td>
</tr>
<tr>
<td>索引缓存</td>
<td>支持</td>
<td>支持</td>
<td>N/A</td>
</tr>
<tr>
<td>数据可压缩</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>空间使用</td>
<td>低</td>
<td>高</td>
<td>N/A</td>
</tr>
<tr>
<td>内存使用</td>
<td>低</td>
<td>高</td>
<td>中等</td>
</tr>
<tr>
<td>批量插入速度</td>
<td>高</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td><strong>外键</strong>约束</td>
<td><strong>不支持</strong></td>
<td><strong>支持</strong></td>
<td><strong>不支持</strong></td>
</tr>
</tbody></table>
<h4 id="4-引擎的操作"><a href="#4-引擎的操作" class="headerlink" title="4. 引擎的操作"></a>4. 引擎的操作</h4><ul>
<li>查询数据库支持的引擎</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>SHOW ENGINES;<br><br>-- 查询数据库支持的存储引擎<br>SHOW ENGINES;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>查询结果</li>
</ul>
<p><img src="/2020/05/04/mysql04/img/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%95%E6%93%8E%E6%9F%A5%E8%AF%A2.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight sql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">-- 表字段含义:</span><br>  <span class="hljs-operator">-</span> support : 指服务器是否支持该存储引擎<br>  <span class="hljs-operator">-</span> transactions : 指存储引擎是否支持事务<br>  <span class="hljs-operator">-</span> XA : 指存储引擎是否支持分布式事务处理<br>  <span class="hljs-operator">-</span> Savepoints : 指存储引擎是否支持保存点<br></code></pre></div></td></tr></table></figure>

<ul>
<li>查询某个数据库中所有数据表的引擎</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法 （查询表状态）<br>SHOW TABLE STATUS FROM 数据库名称;<br><br>-- 查看db4数据库所有表的存储引擎<br>SHOW TABLE STATUS FROM db4;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>查询某个数据库中某个数据表的引擎</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>SHOW TABLE STATUS FROM 数据库名称 WHERE NAME &#x3D; &#39;数据表名称&#39;;<br><br>-- 查看db4数据库中category表的存储引擎<br>SHOW TABLE STATUS FROM db4 WHERE NAME &#x3D; &#39;category&#39;;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>创建数据表，指定存储引擎</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>CREATE TABLE 表名(<br>	列名,数据类型,<br>    ...<br>)ENGINE &#x3D; 引擎名称;<br><br>-- 创建db11数据库<br>CREATE DATABASE db11;<br><br>-- 使用db11数据库<br>USE db11;<br><br>-- 创建engine_test表，指定存储引擎为MyISAM<br>CREATE TABLE engine_test(<br>	id INT PRIMARY KEY AUTO_INCREMENT,<br>	NAME VARCHAR(10)<br>)ENGINE &#x3D; MYISAM;<br><br>-- 查询engine_test表的引擎<br>SHOW TABLE STATUS FROM db11 WHERE NAME &#x3D; &#39;engine_test&#39;;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>修改表的存储引擎</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>ALTER TABLE 表名 ENGINE &#x3D; 引擎名称;<br><br>-- 修改engine_test表的引擎为InnoDB<br>ALTER TABLE engine_test ENGINE &#x3D; INNODB;<br><br>-- 查询engine_test表的引擎<br>SHOW TABLE STATUS FROM db11 WHERE NAME &#x3D; &#39;engine_test&#39;;<br></code></pre></div></td></tr></table></figure>

<h4 id="5-总结：引擎的选择"><a href="#5-总结：引擎的选择" class="headerlink" title="5. 总结：引擎的选择"></a>5. 总结：引擎的选择</h4><ul>
<li>MyISAM ：由于MyISAM不支持事务、不支持外键、支持全文检索和表级锁定，读写相互阻塞，读取速度快，节约资源，所以如果应用是以<strong>查询操作</strong>和<strong>插入操作</strong>为主，只有很少的<strong>更新和删除</strong>操作，并且对事务的完整性、并发性要求不是很高，那么选择这个存储引擎是非常合适的。</li>
<li>InnoDB : 是MySQL的默认存储引擎， 由于InnoDB支持事务、支持外键、行级锁定 ，支持所有辅助索引(5.5.5后不支持全文检索)，高缓存，所以用于对事务的完整性有比较高的要求，在并发条件下要求数据的一致性，读写频繁的操作，那么InnoDB存储引擎是比较合适的选择，比如BBS、计费系统、充值转账等</li>
<li>MEMORY：将所有数据保存在RAM中，在需要快速定位记录和其他类似数据环境下，可以提供更快的访问。MEMORY的缺陷就是对表的大小有限制，太大的表无法缓存在内存中，其次是要确保表的数据可以恢复，数据库异常终止后表中的数据是可以恢复的。MEMORY表通常用于更新不太频繁的小表，用以快速得到访问结果。</li>
<li><strong>总结</strong>：针对不同的需求场景，来选择最适合的存储引擎即可！如果不确定、则使用数据库默认的存储引擎！</li>
</ul>
<h3 id="二、MySQL索引"><a href="#二、MySQL索引" class="headerlink" title="二、MySQL索引"></a>二、MySQL索引</h3><h4 id="1-索引的概念"><a href="#1-索引的概念" class="headerlink" title="1. 索引的概念"></a>1. 索引的概念</h4><ul>
<li><p>我们之前学习过集合，其中的ArrayList集合的特点之一就是有索引。</p>
</li>
<li><p>那么有索引会带来哪些好处呢？</p>
</li>
<li><p>没错，查询数据快！我们可以通过索引来快速查找到想要的数据。那么对于我们的MySQL数据库中的索引功能也是类似的！</p>
</li>
<li><p>MySQL数据库中的索引：<strong>是帮助MySQL高效获取数据的一种数据结构</strong>！所以，<strong>索引的本质就是数据结构</strong>。</p>
</li>
<li><p>在表数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式指向数据， 这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。</p>
</li>
<li><p>一张数据表，用于保存数据。   一个索引配置文件，用于保存索引，每个索引都去指向了某一个数据(表格演示)</p>
</li>
<li><p>举例，无索引和有索引的查找原理</p>
<p><img src="/2020/05/04/mysql04/img/%E7%B4%A2%E5%BC%95%E5%88%86%E6%9E%90%E5%9B%BE.png" srcset="/img/loading.gif" lazyload alt="04"></p>
<ul>
<li>上图左侧是无索引，如果我们要查找id为5的用户数据，需要查找5次</li>
<li>上图右侧是有索引，蓝色数据上方红色的就是给每条数据添加的索引<ul>
<li>他展示的结构类似于平衡二叉树，小的在左边，大的在右边</li>
<li>如果要查找id为5 的，只需要从最上边的4开始查找</li>
<li>5比4大，找4的右侧，找到6</li>
<li>5比6小，找6的左侧，找到5</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="2-索引的分类"><a href="#2-索引的分类" class="headerlink" title="2. 索引的分类"></a>2. 索引的分类</h4><ul>
<li>功能分类 <ul>
<li>普通索引： 最基本的索引，它没有任何限制。</li>
<li>唯一索引：索引列的值必须唯一，但允许有空值。如果是组合索引，则列值组合必须唯一。</li>
<li>主键索引：一种特殊的唯一索引，不允许有空值。一般在建表时同时创建主键索引。</li>
<li>组合索引：顾名思义，就是将单列索引进行组合。</li>
<li>外键索引：只有InnoDB引擎支持外键索引，用来保证数据的一致性、完整性和实现级联操作。</li>
<li>全文索引：快速匹配全部文档的方式。InnoDB引擎5.6版本后才支持全文索引。MEMORY引擎不支持。</li>
</ul>
</li>
<li>结构分类<ul>
<li>B+Tree索引 ：MySQL使用最频繁的一个索引数据结构，是InnoDB和MyISAM存储引擎默认的索引类型。</li>
<li>Hash索引 : MySQL中Memory存储引擎默认支持的索引类型。</li>
</ul>
</li>
</ul>
<h4 id="3-索引的操作"><a href="#3-索引的操作" class="headerlink" title="3. 索引的操作"></a>3. 索引的操作</h4><ul>
<li>数据准备</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 创建db12数据库<br>CREATE DATABASE db12;<br><br>-- 使用db12数据库<br>USE db12;<br><br>-- 创建student表<br>CREATE TABLE student(<br>	id INT PRIMARY KEY AUTO_INCREMENT,<br>	NAME VARCHAR(10),<br>	age INT,<br>	score INT<br>);<br>-- 添加数据<br>INSERT INTO student VALUES (NULL,&#39;张三&#39;,23,98),(NULL,&#39;李四&#39;,24,95),<br>(NULL,&#39;王五&#39;,25,96),(NULL,&#39;赵六&#39;,26,94),(NULL,&#39;周七&#39;,27,99);<br></code></pre></div></td></tr></table></figure>

<ul>
<li>创建索引<ul>
<li>注意：如果一个表中有一列是主键，那么就会默认为其创建主键索引！(主键列不需要单独创建索引)</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法 （unique：唯一索引，fulltext：全文索引，如果不写这俩，就是普通索引）<br>CREATE [UNIQUE|FULLTEXT] INDEX 索引名称<br>[USING 索引类型]  -- 默认是B+TREE<br>ON 表名(列名...);<br><br>-- 为student表中姓名列创建一个普通索引<br>CREATE INDEX idx_name ON student(NAME);<br><br>-- 为student表中年龄列创建一个唯一索引<br>CREATE UNIQUE INDEX idx_age ON student(age);<br></code></pre></div></td></tr></table></figure>

<ul>
<li>查看索引</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>SHOW INDEX FROM 表名;<br><br>-- 查看student表中的索引<br>SHOW INDEX FROM student;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>alter语句添加索引</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 普通索引<br>ALTER TABLE 表名 ADD INDEX 索引名称(列名);<br><br>-- 组合索引<br>ALTER TABLE 表名 ADD INDEX 索引名称(列名1,列名2,...);<br><br>-- 主键索引<br>ALTER TABLE 表名 ADD PRIMARY KEY(主键列名); <br><br>-- （constraint：[kənˈstreɪnt]约束，foreign：[ˈfɒrən] 外国的 ，reference：引用）<br>-- 外键索引(添加外键约束，就是外键索引)<br>ALTER TABLE 表名 ADD CONSTRAINT 外键名 FOREIGN KEY (本表外键列名) REFERENCES 主表名(主键列名);<br><br>-- 唯一索引<br>ALTER TABLE 表名 ADD UNIQUE 索引名称(列名);<br><br>-- 全文索引(mysql只支持文本类型)<br>ALTER TABLE 表名 ADD FULLTEXT 索引名称(列名);<br><br><br>-- 为student表中name列添加全文索引<br>ALTER TABLE student ADD FULLTEXT idx_fulltext_name(name);<br><br>-- 查看student表中的索引<br>SHOW INDEX FROM student;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>删除索引</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>DROP INDEX 索引名称 ON 表名;<br><br>-- 删除student表中的idx_score索引<br>DROP INDEX idx_score ON student;<br><br>-- 查看student表中的索引<br>SHOW INDEX FROM student;<br></code></pre></div></td></tr></table></figure>

<h4 id="4-索引的实现原则"><a href="#4-索引的实现原则" class="headerlink" title="4. 索引的实现原则"></a>4. 索引的实现原则</h4><ul>
<li>索引是在MySQL的存储引擎中实现的，所以每种存储引擎的索引不一定完全相同，也不是所有的引擎支持所有的索引类型。这里我们主要介绍InnoDB引擎的实现的<strong>B+Tree索引</strong>。</li>
<li>B+Tree是一种树型数据结构，是B-Tree的变种。通常使用在数据库和操作系统中的文件系统，特点是能够保持数据稳定有序。我们逐步的来了解一下。</li>
</ul>
<h5 id="4-1-磁盘存储"><a href="#4-1-磁盘存储" class="headerlink" title="4.1 磁盘存储"></a>4.1 磁盘存储</h5><ul>
<li><p>系统从磁盘读取数据到内存时是以磁盘块（block）为基本单位的</p>
</li>
<li><p>位于同一个磁盘块中的数据会被一次性读取出来，而不是需要什么取什么。</p>
</li>
<li><p>InnoDB存储引擎中有页（Page）的概念，页是其磁盘管理的最小单位。InnoDB存储引擎中默认每个页的大小为16KB。</p>
</li>
<li><p>InnoDB引擎将若干个地址连接磁盘块，以此来达到页的大小16KB，在查询数据时如果一个页中的每条数据都能有助于定位数据记录的位置，这将会减少磁盘I/O次数，提高查询效率。</p>
<p><img src="/2020/05/04/mysql04/img/%E7%A3%81%E7%9B%98%E5%AD%98%E5%82%A8.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>上图说明：</li>
<li>例如：在这块磁盘中有三块磁盘块，分别存储三个数据</li>
<li>每个磁盘块都会有一个地址值，通过这个地址值将他们连接起来，最终达到页的大小16kb</li>
<li>比如：现在查询数据5，他并不是将5给返回，而是把5所在的磁盘块内所有的数据4,5,6都返回</li>
<li>最后再匹配5</li>
</ul>
</li>
</ul>
<h5 id="4-2-BTree"><a href="#4-2-BTree" class="headerlink" title="4.2 BTree"></a>4.2 BTree</h5><ul>
<li><p>BTree结构的数据可以让系统高效的找到数据所在的磁盘块。</p>
</li>
<li><p>为了描述BTree，首先定义一条记录为一个二元组[key, data] ，key为记录的键值，对应表中的主键值，data为一行记录中除主键外的数据。</p>
</li>
<li><p>对于不同的记录，key值互不相同。</p>
</li>
<li><p>BTree中的每个节点根据实际情况可以包含大量的关键字信息和分支</p>
</li>
<li><p>如下图所示为一个3阶的BTree： </p>
<p><img src="/2020/05/04/mysql04/img/Btree.png" srcset="/img/loading.gif" lazyload alt="05"></p>
</li>
<li><p>根据图中结构显示，每个节点占用一个盘块的磁盘空间，一个节点上有两个升序排序的数据和三个指向子树根节点的指针，指针存储的是子节点所在磁盘块的地址。</p>
</li>
<li><p>两个数据划分成的三个范围域对应三个指针指向的子树的数据的范围域。</p>
</li>
<li><p>以根节点为例，id为17和35，C2指针指向的子树的数据范围为小于17，C3指针指向的子树的数据范围为17~35，C4指针指向的子树的数据范围为大于35。</p>
</li>
</ul>
<p>查找顺序：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">模拟查找15的过程 : <br><br>1.根节点找到磁盘块1，读入内存。【磁盘I&#x2F;O操作第1次】<br>	比较关键字15在区间（&lt;17），找到磁盘块1的指针C2。<br>2.C2指针找到磁盘块2，读入内存。【磁盘I&#x2F;O操作第2次】<br>	比较关键字15在区间（&gt;12），找到磁盘块2的指针C7。<br>3.C7指针找到磁盘块7，读入内存。【磁盘I&#x2F;O操作第3次】<br>	在磁盘块7中找到关键字15。<br>	<br>-- 分析上面过程，发现需要3次磁盘I&#x2F;O操作，和3次内存查找操作。<br>-- 由于内存中的关键字是一个有序表结构，可以利用二分法查找提高效率。而3次磁盘I&#x2F;O操作是影响整个BTree查找效率的决定因素。BTree使用较少的节点个数，使每次磁盘I&#x2F;O取到内存的数据都发挥了作用，从而提高了查询效率。<br></code></pre></div></td></tr></table></figure>

<h5 id="4-3-B-Tree"><a href="#4-3-B-Tree" class="headerlink" title="4.3 B+Tree"></a>4.3 B+Tree</h5><ul>
<li>B+Tree是在BTree基础上的一种优化，使其更适合实现外存储索引结构，InnoDB存储引擎就是用B+Tree实现其索引结构。</li>
<li>从上一节中的BTree结构图中可以看到每个节点中不仅包含数据的key值（id），还有data值。</li>
<li>而每一个页的存储空间是有限的，如果data数据较大时将会导致每个节点（即一个页）能存储的key的数量很小，当存储的数据量很大时同样会导致B-Tree的深度较大，增大查询时的磁盘I/O次数，进而影响查询效率。</li>
<li>在B+Tree中，所有数据记录节点都是按照键值大小顺序存放在同一层的叶子节点上，而非叶子节点上只存储key值信息，这样可以大大加大每个节点存储的key值数量，降低B+Tree的高度。</li>
<li>B+Tree相对于BTree区别：<ul>
<li>非叶子节点只存储键值信息。</li>
<li>所有叶子节点之间都有一个连接指针。</li>
<li>数据记录都存放在叶子节点中。</li>
</ul>
</li>
<li>将上一节中的BTree优化，由于B+Tree的非叶子节点只存储键值信息，假设每个磁盘块能存储4个键值及指针信息，则变成B+Tree后其结构如下图所示：</li>
</ul>
<p><img src="/2020/05/04/mysql04/img/b+tree.png" srcset="/img/loading.gif" lazyload alt="06"></p>
<ul>
<li><p>如果还是要查询15，</p>
<ul>
<li>会先从根节点开始，15&lt;28，所以找到指针c2</li>
<li>然后10&lt;15&lt;17 ， 所以找到指针c5</li>
<li>最终在磁盘5中找到15</li>
<li>在这个过程中，磁盘1,和磁盘2没有IO操作，因为这俩磁盘中没有保存真正的数据</li>
<li>这样的话效率会高很多</li>
</ul>
</li>
<li><p>所有叶子节点（即数据节点）之间是一种链式环结构（粉红色的箭头），这样有助于进行范围查找</p>
</li>
<li><p>比如：查询3-15之间的数据：</p>
<ul>
<li>先从根节点开始，3&lt;28，找到c2</li>
<li>3&lt;10，找到c4，在c4中就找到了3</li>
<li>接下来要找15，但是此时就不会从根节点找了，因为磁盘4与磁盘5连接在了一起，之间就找到磁盘5了，在磁盘5里找到了15</li>
</ul>
</li>
<li><p>实际情况中每个节点可能不能填充满，因此在数据库中，B+Tree的高度一般都在2<del>4层。MySQL的InnoDB存储引擎在设计时是将根节点常驻内存的，也就是说查找某一键值的行记录时最多只需要1</del>3次磁盘I/O操作。</p>
</li>
</ul>
<h4 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h4><ul>
<li>BTree 数据结构<ul>
<li>每个节点中不仅包含 key 值，还有数据。会增加查询数据时磁盘的 IO 次数。</li>
</ul>
</li>
<li>B+Tree 数据结构<ul>
<li>非叶子节点只存储 key 值。</li>
<li>所有数据存储在叶子节点。</li>
<li>所有叶子节点之间都有连接指针。</li>
</ul>
</li>
<li>B+Tree 好处<ul>
<li>提高查询速度。</li>
<li>减少磁盘的 IO 次数。</li>
<li>树型结构较小。</li>
</ul>
</li>
</ul>
<h4 id="6-索引设计原则"><a href="#6-索引设计原则" class="headerlink" title="6. 索引设计原则"></a>6. 索引设计原则</h4><p>索引的设计可以遵循一些已有的原则，创建索引的时候请尽量考虑符合这些原则，便于提升索引的使用效率，更高效的使用索引。</p>
<ul>
<li><p>创建索引时的原则</p>
<ol>
<li>对查询频次较高，且数据量比较大的表建立索引。</li>
<li>使用唯一索引，区分度越高，使用索引的效率越高。</li>
<li>索引字段的选择，最佳候选列应当从where子句的条件中提取，如果where子句中的组合比较多，那么应当挑选最常用、过滤效果最好的列的组合。</li>
<li>索引可以有效的提升查询数据的效率，但索引数量不是多多益善，索引越多，维护索引的代价自然也就水涨船高。对于插入、更新、删除等DML操作比较频繁的表来说，索引过多，会引入相当高的维护代价，降低DML操作的效率，增加相应操作的时间消耗。另外索引过多的话，MySQL也会犯选择困难病，虽然最终仍然会找到一个可用的索引，但无疑提高了选择的代价。</li>
<li>使用短索引，索引创建之后也是使用硬盘来存储的，因此提升索引访问的I/O效率，也可以提升总体的访问效率。假如构成索引的字段总长度比较短，那么在给定大小的存储块内可以存储更多的索引值，相应的可以有效的提升MySQL访问索引的I/O效率。</li>
</ol>
</li>
<li><p>最左匹配原则(适用组合索引)</p>
<ul>
<li><p>在mysql建立联合索引时会遵循最左前缀匹配的原则，即最左优先，在检索数据时从联合索引的最左边开始匹配，</p>
</li>
<li><p>例如：为 user 表中的 name、address、phone 列添加组合索引</p>
<figure class="highlight sql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">ADD</span> INDEX index_three(name,address,phone);<br></code></pre></div></td></tr></table></figure></li>
<li><p>此时，组合索引 idx_three 实际建立了 (name)、(name,address)、(name,address,phone) 三个索引。</p>
</li>
<li><p>所以下面的三个SQL语句都可以命中索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> address <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;北京&#x27;</span> <span class="hljs-keyword">AND</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;12345&#x27;</span> <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;张三&#x27;</span>;<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;张三&#x27;</span> <span class="hljs-keyword">AND</span> address <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;北京&#x27;</span>;<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;张三&#x27;</span>;<br></code></pre></div></td></tr></table></figure></li>
<li><p>这三条 SQL 语句在检索时分别会使用以下索引进行数据匹配</p>
<blockquote>
<p>(name,address,phone)<br>(name,address)<br>(name)</p>
</blockquote>
</li>
<li><p>索引的字段可以是任意顺序的，如：</p>
<figure class="highlight sql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">-- 优化器会帮助我们调整顺序，下面的SQL语句都可以命中索引</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> address <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;北京&#x27;</span> <span class="hljs-keyword">AND</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;12345&#x27;</span> <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;张三&#x27;</span>;<br></code></pre></div></td></tr></table></figure></li>
<li><p>Mys    ql的优化器会帮助我们调整where条件中的顺序，以匹配我们建立的索引。</p>
</li>
<li><p>联合索引中最左边的列不包含在条件查询中，所以根据上面的原则，下面的SQL语句就不会命中索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-comment">-- 联合索引中最左边的列不包含在条件查询中，下面的SQL语句就不会命中索引</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> address <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;北京&#x27;</span> <span class="hljs-keyword">AND</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;12345&#x27;</span>;<br></code></pre></div></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="三、MySQL锁"><a href="#三、MySQL锁" class="headerlink" title="三、MySQL锁"></a>三、MySQL锁</h3><h4 id="1-锁的概念"><a href="#1-锁的概念" class="headerlink" title="1. 锁的概念"></a>1. 锁的概念</h4><ul>
<li><p>之前我们学习过多线程，多线程当中如果想保证数据的准确性是如何实现的呢？没错，通过同步实现。同步就相当于是加锁。加了锁以后有什么好处呢？当一个线程真正在操作数据的时候，其他线程只能等待。当一个线程执行完毕后，释放锁。其他线程才能进行操作！</p>
</li>
<li><p>那么我们的MySQL数据库中的锁的功能也是类似的。在我们学习事务的时候，讲解过事务的隔离性，可能会出现脏读、不可重复读、幻读的问题，当时我们的解决方式是通过修改事务的隔离级别来控制，但是数据库的隔离级别呢我们并不推荐修改。所以，锁的作用也可以解决掉之前的问题！</p>
</li>
<li><p><strong>锁机制</strong> : 数据库为了保证数据的一致性，而使用各种共享的资源在被并发访问时变得有序所设计的一种规则。</p>
</li>
<li><p>举例，在电商网站购买商品时，商品表中只存有1个商品，而此时又有两个人同时购买，那么谁能买到就是一个关键的问题。</p>
<p>这里会用到事务进行一系列的操作：</p>
<ol>
<li>先从商品表中取出物品的数据</li>
<li>然后插入订单</li>
<li>付款后，再插入付款表信息</li>
<li>更新商品表中商品的数量</li>
</ol>
<p>以上过程中，使用锁可以对商品数量数据信息进行保护，实现隔离，即只允许第一位用户完成整套购买流程，而其他用户只能等待，这样就解决了并发中的矛盾问题。</p>
</li>
<li><p>在数据库中，数据是一种供许多用户共享访问的资源，如何保证数据并发访问的一致性、有效性，是所有数据库必须解决的一个问题，MySQL由于自身架构的特点，在不同的存储引擎中，都设计了面对特定场景的锁定机制，所以引擎的差别，导致锁机制也是有很大差别的。</p>
</li>
</ul>
<h4 id="2-锁的分类"><a href="#2-锁的分类" class="headerlink" title="2. 锁的分类"></a>2. 锁的分类</h4><ul>
<li>按操作分类：<ul>
<li><strong>共享锁</strong>：也叫读锁。针对同一份数据，多个事务读取操作可以同时加锁而不互相影响 ，但是不能修改数据记录</li>
<li><strong>排他锁</strong>：也叫写锁。当前的操作没有完成前,会阻断其他操作的读取和写入</li>
</ul>
</li>
<li>按粒度分类：<ul>
<li><strong>表级锁</strong>：操作时，会锁定整个表。开销小，加锁快；不会出现死锁；锁定力度大，发生锁冲突概率高，并发度最低。偏向于MyISAM存储引擎！</li>
<li><strong>行级锁</strong>：操作时，会锁定当前操作行。开销大，加锁慢；会出现死锁；锁定粒度小，发生锁冲突的概率低，并发度高。偏向于InnoDB存储引擎！</li>
<li><strong>页级锁</strong>：锁的粒度、发生冲突的概率和加锁的开销介于表锁和行锁之间，会出现死锁，并发性能一般。</li>
</ul>
</li>
<li>按使用方式分类：<ul>
<li><strong>悲观锁</strong>：每次查询数据时都认为别人会修改，很悲观，所以查询时加锁</li>
<li><strong>乐观锁</strong>：每次查询数据时都认为别人不会修改，很乐观，但是更新时会判断一下在此期间别人有没有去更新这个数据</li>
</ul>
</li>
<li>不同存储引擎支持的锁</li>
</ul>
<table>
<thead>
<tr>
<th>存储引擎</th>
<th>表级锁</th>
<th>行级锁</th>
<th>页级锁</th>
</tr>
</thead>
<tbody><tr>
<td>MyISAM</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>InnoDB</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>MEMORY</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>BDB</td>
<td>支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
</tbody></table>
<h4 id="3-InnoDB锁"><a href="#3-InnoDB锁" class="headerlink" title="3. InnoDB锁"></a>3. InnoDB锁</h4><ul>
<li><p>共享锁特点</p>
<ul>
<li>数据可以被多个事务查询，但是不能修改</li>
</ul>
</li>
<li><p>数据准备</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 创建db13数据库<br>CREATE DATABASE db13;<br><br>-- 使用db13数据库<br>USE db13;<br><br>-- 创建student表<br>CREATE TABLE student(<br>	id INT PRIMARY KEY AUTO_INCREMENT,<br>	NAME VARCHAR(10),<br>	age INT,<br>	score INT<br>);<br>-- 添加数据<br>INSERT INTO student VALUES (NULL,&#39;张三&#39;,23,99),(NULL,&#39;李四&#39;,24,95),<br>(NULL,&#39;王五&#39;,25,98),(NULL,&#39;赵六&#39;,26,97);<br></code></pre></div></td></tr></table></figure>

<h5 id="3-1-共享锁"><a href="#3-1-共享锁" class="headerlink" title="3.1 共享锁"></a>3.1 共享锁</h5><figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法 (mode：模式，share mode：共享模式，共享锁模式)<br>SELECT语句 LOCK IN SHARE MODE;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 窗口1<br>&#x2F;*<br>	共享锁：数据可以被多个事务查询，但是不能修改<br>*&#x2F;<br>-- 开启事务  （窗口2也开启事务）<br>START TRANSACTION;<br> <br>-- 查询id为1的数据记录。加入共享锁 （窗口2查询id为1的数据，发现可以查询）<br>SELECT * FROM student WHERE id&#x3D;1 LOCK IN SHARE MODE;<br><br>-- 然后窗口2 ： 查询id为1的数据记录，并加入共享锁<br>-- 窗口2： 修改id为1的姓名为张三三<br>-- 窗口1 ： 提交事务 ， 发现窗口2的修改立马生效<br>-- 窗口1：再次开启事务，并且 查询id为1的数据记录。加入共享锁  （提交过事务所就没了，需要重开）<br>-- 窗口2： 修改id为2的姓名为李四四 <br>-- 两个窗口都提交事务，并且都重新开事务<br><br>-- 查询分数为99分的数据记录。加入共享锁<br>SELECT * FROM student WHERE score&#x3D;99 LOCK IN SHARE MODE;<br><br>-- 窗口2： 修改id为3的姓名为王五五 <br>-- （发现失败，因为加锁的语句中的查询条件如果不带索引列，加的锁就会提升为表锁，整个表的数据都会上锁）<br>-- 这次查询条件是score，这个不是索引列，上次查询条件是id，id是主键，默认是主键索引<br><br>-- 提交事务<br>COMMIT;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 窗口2<br>-- 开启事务<br>START TRANSACTION;<br><br>-- 查询id为1的数据记录(普通查询，可以查询)<br>SELECT * FROM student WHERE id&#x3D;1;<br><br>-- 查询id为1的数据记录，并加入共享锁(可以查询。共享锁和共享锁兼容)<br>SELECT * FROM student WHERE id&#x3D;1 LOCK IN SHARE MODE;<br><br>-- 修改id为1的姓名为张三三(不能修改，会出现锁的情况。只有窗口1提交事务后，才能修改成功)<br>UPDATE student SET NAME&#x3D;&#39;张三三&#39; WHERE id &#x3D; 1;<br><br>-- 修改id为2的姓名为李四四(修改成功，InnoDB引擎默认是行锁，意思就是只有id为1的数据有锁)<br>UPDATE student SET NAME&#x3D;&#39;李四四&#39; WHERE id &#x3D; 2;<br><br>-- 修改id为3的姓名为王五五(注意：InnoDB引擎如果不采用带索引的列。则会提升为表锁)<br>UPDATE student SET NAME&#x3D;&#39;王五五&#39; WHERE id &#x3D; 3;<br><br>-- 提交事务<br>COMMIT;<br></code></pre></div></td></tr></table></figure>

<h5 id="3-2-排他锁"><a href="#3-2-排他锁" class="headerlink" title="3.2 排他锁"></a>3.2 排他锁</h5><ul>
<li>排他锁特点<ul>
<li>加锁的数据，不能被其他事务加锁查询或修改</li>
</ul>
</li>
<li>语法：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>SELECT语句 FOR UPDATE;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>演示</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 窗口1<br>&#x2F;*<br>	排他锁：加锁的数据，不能被其他事务加锁查询或修改<br>*&#x2F;<br>-- 开启事务 （窗口2也开启事务）<br>START TRANSACTION;<br><br>-- 查询id为1的数据记录，并加入排他锁<br>SELECT * FROM student WHERE id&#x3D;1 FOR UPDATE;<br><br>-- 窗口2 ： 查询id为1的数据记录<br>-- 窗口2 ： 查询id为1的数据记录，并加入共享锁<br>-- 窗口1 ： 提交事务， 才能查询到1并加共享锁<br><br>-- 窗口1和2，提交事务，并重新都开启事务<br>-- 窗口1： 询id为1的数据记录，并加入排他锁<br>-- 窗口2： 查询id为1的数据记录，并加入排他锁<br><br>-- 窗口1和2，提交事务，并重新都开启事务<br>-- 窗口1： 查询id为1的数据记录，并加入排他锁<br>-- 窗口2： 修改id为1的姓名为张三<br><br>-- 提交事务<br>COMMIT;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 窗口2<br>-- 开启事务<br>START TRANSACTION;<br><br>-- 查询id为1的数据记录(普通查询没问题)<br>SELECT * FROM student WHERE id&#x3D;1;<br><br>-- 查询id为1的数据记录，并加入共享锁(不能查询。因为排他锁不能和其他锁共存)<br>SELECT * FROM student WHERE id&#x3D;1 LOCK IN SHARE MODE;<br><br>-- 查询id为1的数据记录，并加入排他锁(不能查询。因为排他锁不能和其他锁共存)<br>SELECT * FROM student WHERE id&#x3D;1 FOR UPDATE;<br><br>-- 修改id为1的姓名为张三(不能修改，会出现锁的情况。只有窗口1提交事务后，才能修改成功)<br>UPDATE student SET NAME&#x3D;&#39;张三&#39; WHERE id&#x3D;1;<br><br>-- 提交事务<br>COMMIT;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>注意：锁的兼容性<ul>
<li>共享锁和共享锁     兼容</li>
<li>共享锁和排他锁     冲突</li>
<li>排他锁和排他锁     冲突</li>
<li>排他锁和共享锁     冲突</li>
</ul>
</li>
</ul>
<h4 id="4-MyISAM锁"><a href="#4-MyISAM锁" class="headerlink" title="4. MyISAM锁"></a>4. MyISAM锁</h4><ul>
<li><p>MyISAM引擎：不支持行锁，只能加表锁</p>
</li>
<li><p>数据准备</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 创建product表<br>CREATE TABLE product(<br>	id INT PRIMARY KEY AUTO_INCREMENT,<br>	NAME VARCHAR(20),<br>	price INT<br>)ENGINE &#x3D; MYISAM;  -- 指定存储引擎为MyISAM<br><br>-- 添加数据<br>INSERT INTO product VALUES (NULL,&#39;华为手机&#39;,4999),(NULL,&#39;小米手机&#39;,2999),<br>(NULL,&#39;苹果&#39;,8999),(NULL,&#39;中兴&#39;,1999);<br></code></pre></div></td></tr></table></figure>

<h5 id="4-1-读锁"><a href="#4-1-读锁" class="headerlink" title="4.1 读锁"></a>4.1 读锁</h5><ul>
<li>读锁特点<ul>
<li>所有连接只能查询数据，不能修改</li>
</ul>
</li>
<li>语法：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>-- 加锁<br>LOCK TABLE 表名 READ;<br><br>-- 解锁(将当前会话所有的表进行解锁)<br>UNLOCK TABLES;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>演示：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 窗口1<br>&#x2F;*<br>	读锁：所有连接只能读取数据，不能修改<br>*&#x2F;<br>-- 为product表加入读锁<br>LOCK TABLE product READ;<br><br>-- 查询id为1的数据(查询成功)<br>SELECT * FROM product where id&#x3D;1;<br>-- 窗口2：查询id为1的数据<br>-- 窗口2：修改id为1的数据<br><br>-- 修改华为手机的价格为5999(修改失败，窗口1修改数据也是会失败，因为读锁只允许读取)<br>UPDATE product SET price&#x3D;5999 WHERE id&#x3D;1;<br><br>-- 解锁<br>UNLOCK TABLES;<br><br>-- 窗口1解锁之后，窗口1和2：可以修改数据了<br></code></pre></div></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 窗口2<br>-- 查询id为1的数据(查询成功)<br>SELECT * FROM product where id&#x3D;1;<br><br>-- 修改id为1的数据:华为手机的价格为5999(不能修改，窗口1解锁后才能修改成功)<br>UPDATE product SET price&#x3D;5999 WHERE id&#x3D;1;<br></code></pre></div></td></tr></table></figure>

<h5 id="4-2-写锁"><a href="#4-2-写锁" class="headerlink" title="4.2 写锁"></a>4.2 写锁</h5><ul>
<li>写锁特点 <ul>
<li>其他连接不能查询和修改数据</li>
<li>当前连接可以查询和修改数据</li>
</ul>
</li>
<li>语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 标准语法<br>-- 加锁<br>LOCK TABLE 表名 WRITE;<br><br>-- 解锁(将当前会话所有的表进行解锁)<br>UNLOCK TABLES;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>演示：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 窗口1<br>&#x2F;*<br>	写锁：其他连接不能查询和修改数据<br>*&#x2F;<br>-- 为product表添加写锁<br>LOCK TABLE product WRITE;<br><br>-- 查询product表(查询成功)<br>SELECT * FROM product;<br><br>-- 修改小米手机的金额为3999(修改成功)<br>UPDATE product SET price&#x3D;3999 WHERE id&#x3D;2;<br><br>-- 窗口2： 查询 ， 修改 ，都不成功<br><br>-- 解锁<br>UNLOCK TABLES;<br><br>-- 窗口1解锁之后，窗口2才能查询和修改<br></code></pre></div></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 窗口2<br>-- 查询product表(不能查询。只有窗口1解锁后才能查询成功)<br>SELECT * FROM product;<br><br>-- 修改小米手机的金额为2999(不能修改。只有窗口1解锁后才能修改成功)<br>UPDATE product SET price&#x3D;2999 WHERE id&#x3D;2;<br></code></pre></div></td></tr></table></figure>

<h4 id="5-悲观锁和乐观锁"><a href="#5-悲观锁和乐观锁" class="headerlink" title="5. 悲观锁和乐观锁"></a>5. 悲观锁和乐观锁</h4><ul>
<li><p>悲观锁的概念</p>
<ul>
<li>就是很悲观，它对于数据被外界修改的操作持保守态度，认为数据随时会修改。</li>
<li>整个数据处理中需要将数据加锁。悲观锁一般都是依靠关系型数据库提供的锁机制。</li>
<li>我们之前所学的行锁，表锁不论是读写锁都是悲观锁。</li>
</ul>
</li>
<li><p>乐观锁的概念</p>
<ul>
<li>就是很乐观，每次自己操作数据的时候认为没有人会来修改它，所以不去加锁。</li>
<li>但是在更新的时候会去判断在此期间数据有没有被修改。</li>
<li>需要用户自己去实现，不会发生并发抢占资源，只有在提交操作的时候检查是否违反数据完整性。</li>
</ul>
</li>
<li><p>悲观锁和乐观锁使用前提</p>
<ul>
<li>对于读的操作远多于写的操作的时候，这时候一个更新操作加锁会阻塞所有的读取操作，降低了吞吐量。最后还要释放锁，锁是需要一些开销的，这时候可以选择乐观锁。</li>
<li>如果是读写比例差距不是非常大或者系统没有响应不及时，吞吐量瓶颈的问题，那就不要去使用乐观锁，它增加了复杂度，也带来了业务额外的风险。这时候可以选择悲观锁。</li>
</ul>
</li>
<li><p>乐观锁的实现方式</p>
<ul>
<li><p>版本号</p>
<ul>
<li>给数据表中添加一个version列，每次更新后都将这个列的值加1。</li>
<li>读取数据时，将版本号读取出来，在执行更新的时候，比较版本号。</li>
<li>如果相同则执行更新，如果不相同，说明此条数据已经发生了变化。</li>
<li>用户自行根据这个通知来决定怎么处理，比如重新开始一遍，或者放弃本次更新。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 数据准备<br>-- 创建city表<br>CREATE TABLE city(<br>	id INT PRIMARY KEY AUTO_INCREMENT,  -- 城市id<br>	NAME VARCHAR(20),                   -- 城市名称<br>	VERSION INT                         -- 版本号<br>);<br><br>-- 添加数据<br>INSERT INTO city VALUES (NULL,&#39;北京&#39;,1),(NULL,&#39;上海&#39;,1),(NULL,&#39;广州&#39;,1),(NULL,&#39;深圳&#39;,1);<br><br>-- 演示乐观锁：<br>-- 修改北京为北京市<br>-- 1.查询北京的version<br>SELECT VERSION FROM city WHERE NAME&#x3D;&#39;北京&#39;; -- 发现查询出来的结果是1<br>-- 2.修改北京为北京市，版本号+1。并对比版本号<br>UPDATE city SET NAME&#x3D;&#39;北京市&#39;,VERSION&#x3D;VERSION+1 WHERE NAME&#x3D;&#39;北京&#39; AND VERSION&#x3D;1;<br>-- 更新的时候，查询一下这条数据还是当初的那条数据不是（version&#x3D;1）<br>-- 如果从查询，到修改这个间隔时间内，没有人修改数据，那version还是1，那么就能修改成功<br>-- 反之，不成功<br></code></pre></div></td></tr></table></figure></li>
<li><p>时间戳</p>
<ul>
<li>和版本号方式基本一样，给数据表中添加一个列，名称无所谓，数据类型需要是timestamp</li>
<li>每次更新后都将最新时间插入到此列。</li>
<li>读取数据时，将时间读取出来，在执行更新的时候，比较时间。</li>
<li>如果相同则执行更新，如果不相同，说明此条数据已经发生了变化。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="6-锁的总结"><a href="#6-锁的总结" class="headerlink" title="6. 锁的总结"></a>6. 锁的总结</h4><ul>
<li><p>表锁和行锁</p>
<ul>
<li>行锁：锁的粒度更细，加行锁的性能损耗较大。并发处理能力较高。InnoDB引擎默认支持！</li>
<li>表锁：锁的粒度较粗，加表锁的性能损耗较小。并发处理能力较低。InnoDB、MyISAM引擎支持！</li>
</ul>
</li>
<li><p>InnoDB锁优化建议</p>
<ul>
<li><p>尽量通过带索引的列来完成数据查询，从而避免InnoDB无法加行锁而升级为表锁。</p>
</li>
<li><p>合理设计索引，索引要尽可能准确，尽可能的缩小锁定范围，避免造成不必要的锁定。</p>
</li>
<li><p>尽可能减少基于范围的数据检索过滤条件。</p>
</li>
<li><p>尽量控制事务的大小，减少锁定的资源量和锁定时间长度。</p>
</li>
<li><p>在同一个事务中，尽可能做到一次锁定所需要的所有资源，减少死锁产生概率。</p>
</li>
<li><p>对于非常容易产生死锁的业务部分，可以尝试使用升级锁定颗粒度，通过表级锁定来减少死锁的产生。</p>
</li>
</ul>
</li>
</ul>
<h3 id="四、集群-amp-Mycat-（不讲）"><a href="#四、集群-amp-Mycat-（不讲）" class="headerlink" title="四、集群&amp;Mycat （不讲）"></a>四、集群&amp;Mycat （不讲）</h3><h4 id="1-集群的概念"><a href="#1-集群的概念" class="headerlink" title="1. 集群的概念"></a>1. 集群的概念</h4><ul>
<li>如今随着互联网的发展，数据的量级也是成指数的增长，从GB到TB到PB。对数据的各种操作也是愈加的困难，传统的关系型数据库已经无法满足快速查询与插入数据的需求。一台数据库服务器已经无法满足海量数据的存储需求，所以由多台数据库构成的数据库集群成了必然的方式。不过，为了保证数据的一致性，查询效率等，同时又要解决多台服务器间的通信、负载均衡等问题。</li>
<li>MyCat是一款数据库集群软件，是阿里曾经开源的知名产品——Cobar，简单的说，MyCAT就是：一个新颖的数据库中间件产品支持MySQL集群，提供高可用性数据分片集群。你可以像使用mysql一样使用mycat。对于开发人员来说根本感觉不到mycat的存在。MyCat不单单是支持MySQL，像常用的关系型数据库Oracle、SqlServer都支持。</li>
</ul>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/07.png" srcset="/img/loading.gif" lazyload alt="07"></p>
<h4 id="2-集群的原理"><a href="#2-集群的原理" class="headerlink" title="2. 集群的原理"></a>2. 集群的原理</h4><ul>
<li>我们来说个例子，大海捞针和一个水瓶里捞针，毋庸置疑水瓶里一定能更快找到针，因为它需要检索的范围更小。数据库集群也是如此原理，我们可以将一个数据量为300G的数据库数据平均拆分成3部分，每个数据库中只存储100G数据，此时用户搜索，先经过我们中间代理层，中间代理层同时发出3个请求执行查询，比如第1台返回100条数据，耗时3秒，第2台返回200条数据，耗时3秒，第3台返回500条数据，耗时3秒，此时中间件只需要在800条记录中进行筛选，即可检索出用户要的结果，此时耗时其实一共只有3秒，因为每台机器做运算的时候，都是同时执行。如果我们此时直接在300G的数据库查询，耗时10秒，那使用中间件进行集群的效率就非常明显</li>
</ul>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/08.png" srcset="/img/loading.gif" lazyload alt="08"></p>
<ul>
<li>MyCat的实现流程和这个流程大致相似。MyCat自身不存储数据，但用户每次链接数据库的时候，直接连接MyCat即可.所以我们MyCat自身其实就是个逻辑数据库，它自身还有表结构，表结构叫逻辑表。</li>
</ul>
<h4 id="3-Mycat环境搭建"><a href="#3-Mycat环境搭建" class="headerlink" title="3. Mycat环境搭建"></a>3. Mycat环境搭建</h4><h5 id="3-1-Mycat下载和安装"><a href="#3-1-Mycat下载和安装" class="headerlink" title="3.1 Mycat下载和安装"></a>3.1 Mycat下载和安装</h5><ul>
<li><p>官网：<code>http://www.mycat.io/</code></p>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/09.png" srcset="/img/loading.gif" lazyload alt="09"></p>
</li>
<li><p>下载地址 : <code>http://dl.mycat.io/</code></p>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/10.png" srcset="/img/loading.gif" lazyload alt="10"></p>
</li>
<li><p>选择1.6.7.1的版本，下载到D盘，安装包入下图：</p>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/11.png" srcset="/img/loading.gif" lazyload alt="11"></p>
</li>
<li><p>上传：使用SecureCRT的SFTP命令，将文件发送到Linux虚拟机root目录下：</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">sftp&gt; put D:\Mycat-server-<span class="hljs-number">1.6</span><span class="hljs-number">.7</span><span class="hljs-number">.1</span>-release-<span class="hljs-number">20190627191042</span>-linux.tar.gz <br></code></pre></div></td></tr></table></figure></li>
<li><p>解压：解压mycat.tar.gz并查看</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">tar -zxvf mycat.tar.gz<br>cd mycat<br>ll<br></code></pre></div></td></tr></table></figure>

<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/12.png" srcset="/img/loading.gif" lazyload alt="12"></p>
</li>
<li><p>授权：设置mycat权限</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">chmod -R <span class="hljs-number">777</span> mycat<br></code></pre></div></td></tr></table></figure></li>
<li><p>环境变量：配置环境变量</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">vi /etc/profile <br><span class="hljs-comment">// 添加</span><br>export MYCAT_HOME=/root/mycat<br><br><span class="hljs-comment">// 使环境变量生效</span><br>source /etc/profile<br></code></pre></div></td></tr></table></figure></li>
<li><p>启动mycat</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// 进入bin目录</span><br>[root@localhost]# cd /root/mycat/bin<br><br><span class="hljs-comment">// 执行启动命令</span><br>[root@localhost bin]# ./mycat start<br></code></pre></div></td></tr></table></figure></li>
<li><p>查看：检测端口监听状况，Mycat的端口号是8066</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">[root@localhost bin]# netstat -ant|grep 8066<br></code></pre></div></td></tr></table></figure>

<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/13.png" srcset="/img/loading.gif" lazyload alt="13"></p>
</li>
<li><p>连接：使用SQLYog连接Mycat</p>
</li>
</ul>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/14.png" srcset="/img/loading.gif" lazyload alt="14"></p>
<ul>
<li><p>连接后显示：</p>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/15.png" srcset="/img/loading.gif" lazyload alt="15"></p>
</li>
</ul>
<h5 id="3-2-环境准备"><a href="#3-2-环境准备" class="headerlink" title="3.2 环境准备"></a>3.2 环境准备</h5><ul>
<li>配置模型</li>
</ul>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/16.png" srcset="/img/loading.gif" lazyload alt="16"></p>
<ul>
<li>克隆虚拟机</li>
</ul>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/17.png" srcset="/img/loading.gif" lazyload alt="17"></p>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/18.png" srcset="/img/loading.gif" lazyload alt="18"></p>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/19.png" srcset="/img/loading.gif" lazyload alt="19"></p>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/20.png" srcset="/img/loading.gif" lazyload alt="20"></p>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/21.png" srcset="/img/loading.gif" lazyload alt="21"></p>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/22.png" srcset="/img/loading.gif" lazyload alt="22"></p>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/23.png" srcset="/img/loading.gif" lazyload alt="23"></p>
<ul>
<li><p>修改配置网卡</p>
<ul>
<li>在第二个虚拟机中，生成全新mac地址</li>
</ul>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/24.png" srcset="/img/loading.gif" lazyload alt="24"></p>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/25.png" srcset="/img/loading.gif" lazyload alt="25"></p>
<ul>
<li>重启网络</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs linux">&#x2F;&#x2F; 重启网络<br>service network restart<br>&#x2F;&#x2F;查看ip地址<br>ip addr<br></code></pre></div></td></tr></table></figure></li>
<li><p>修改mysql配置文件,更改uuid</p>
<ul>
<li>在第二个服务器上，修改mysql的uuid</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> 编辑配置文件<br>vi <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/mysql/</span>auto.cnf<br><span class="hljs-regexp">//</span> 将server-uuid更改<br></code></pre></div></td></tr></table></figure></li>
<li><p>启动MySQL并查看</p>
</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>将两台服务器的防火墙关闭<br>systemctl stop firewalld<br><br><span class="hljs-regexp">//</span>启动两台服务器的mysql<br>service mysqld restart<br><br><span class="hljs-regexp">//</span>启动两台服务器的mycat<br>cd <span class="hljs-regexp">/root/my</span>cat/bin<br>./mycat restart<br><br><span class="hljs-regexp">//</span>查看监听端口<br>netstat -ant|grep <span class="hljs-number">3306</span><br>netstat -ant|grep <span class="hljs-number">8066</span><br><br><span class="hljs-regexp">//</span>使用sqlyog测试连接<br></code></pre></div></td></tr></table></figure>

<h4 id="4-主从复制"><a href="#4-主从复制" class="headerlink" title="4. 主从复制"></a>4. 主从复制</h4><ul>
<li><p>主从复制的概念</p>
<ul>
<li>为了使用Mycat进行读写分离，我们先要配置MySQL数据库的主从复制。</li>
<li>从服务器自动同步主服务器的数据，从而达到数据一致。</li>
<li>进而，我们可以写操作时，只操作主服务器，而读操作，就可以操作从服务器了。</li>
<li>原理：主服务器在处理数据时，生成binlog日志，通过对日志的备份，实现从服务器的数据同步。</li>
</ul>
<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/26.png" srcset="/img/loading.gif" lazyload alt="26"></p>
</li>
<li><p>主服务器的配置</p>
<ul>
<li>在第一个服务器上，编辑mysql配置文件</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> 编辑mysql配置文件<br>vi <span class="hljs-regexp">/etc/my</span>.cnf<br><br><span class="hljs-regexp">//</span>在[mysqld]下面加上：<br>log-bin=mysql-bin <span class="hljs-comment"># 开启复制操作</span><br>server-id=<span class="hljs-number">1</span> <span class="hljs-comment"># master is 1</span><br>innodb_flush_log_at_trx_commit=<span class="hljs-number">1</span><br>sync_binlog=<span class="hljs-number">1</span><br></code></pre></div></td></tr></table></figure>

<ul>
<li>登录mysql，创建用户并授权</li>
</ul>
<figure class="highlight lasso"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs lasso"><span class="hljs-comment">// 登录mysql</span><br>mysql <span class="hljs-params">-u</span> root <span class="hljs-params">-p</span><br><br><span class="hljs-comment">// 去除密码权限</span><br><span class="hljs-built_in">SET</span> <span class="hljs-built_in">GLOBAL</span> validate_password_policy=<span class="hljs-number">0</span>;<br><span class="hljs-built_in">SET</span> <span class="hljs-built_in">GLOBAL</span> validate_password_length=<span class="hljs-number">1</span>;<br><br><span class="hljs-comment">// 创建用户</span><br>CREATE USER <span class="hljs-string">&#x27;hm&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;itheima&#x27;</span>;<br><br><span class="hljs-comment">// 授权</span><br>GRANT <span class="hljs-literal">ALL</span> <span class="hljs-keyword">ON</span> *.* <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;hm&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span>;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>重启mysql服务，登录mysql服务</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> 重启mysql<br>service mysqld restart<br><br><span class="hljs-regexp">//</span> 登录mysql<br>mysql -u root -p<br></code></pre></div></td></tr></table></figure>

<ul>
<li>查看主服务器的配置</li>
</ul>
<figure class="highlight crmsh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs crmsh">// 查看主服务器配置<br>show <span class="hljs-keyword">master</span> <span class="hljs-title">status</span>;<br></code></pre></div></td></tr></table></figure>

<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/27.png" srcset="/img/loading.gif" lazyload alt="27"></p>
</li>
<li><p>从服务器的配置</p>
<ul>
<li>在第二个服务器上，编辑mysql配置文件</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> 编辑mysql配置文件<br>vi <span class="hljs-regexp">/etc/my</span>.cnf<br><br><span class="hljs-regexp">//</span> 在[mysqld]下面加上：<br>server-id=<span class="hljs-number">2</span><br></code></pre></div></td></tr></table></figure>

<ul>
<li>登录mysql</li>
</ul>
<figure class="highlight stata"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stata"><span class="hljs-comment">// 登录mysql</span><br>mysql -<span class="hljs-keyword">u</span> root -p<br><br><span class="hljs-comment">// 执行</span><br><span class="hljs-keyword">use</span> mysql;<br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> slave_master_info;<br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> slave_relay_log_info;<br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> slave_worker_info;<br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> innodb_index_stats;<br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> innodb_table_stats;<br>source /usr/share/mysql/mysql_system_tables.sql;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>重启mysql，重新登录，配置从节点</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> 重启mysql<br>service mysqld restart<br><br><span class="hljs-regexp">//</span> 重新登录mysql<br>mysql -u root -p<br><br><span class="hljs-regexp">//</span> 执行<br>change master to master_host=<span class="hljs-string">&#x27;主服务器ip地址&#x27;</span>,master_port=<span class="hljs-number">3306</span>,master_user=<span class="hljs-string">&#x27;hm&#x27;</span>,master_password=<span class="hljs-string">&#x27;itheima&#x27;</span>,master_log_file=<span class="hljs-string">&#x27;mysql-bin.000001&#x27;</span>,master_log_pos=<span class="hljs-number">4642</span>;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>重启mysql，重新登录，开启从节点</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> 重启mysql<br>service mysqld restart<br><br><span class="hljs-regexp">//</span> 重新登录mysql<br>mysql -u root -p<br><br><span class="hljs-regexp">//</span> 开启从节点<br>start slave;<br><br><span class="hljs-regexp">//</span> 查询结果<br>show slave status\G;<br><span class="hljs-regexp">//</span>Slave_IO_Running和Slave_SQL_Running都为yes才表示同步成功。<br></code></pre></div></td></tr></table></figure>

<p><img src="/2020/05/04/mysql04/MySQL%E9%AB%98%E7%BA%A7-04-%E6%8E%88%E8%AF%BE%E7%AC%94%E8%AE%B0.assets/28.png" srcset="/img/loading.gif" lazyload alt="28"></p>
</li>
<li><p>测试</p>
<ul>
<li>sqlyog连接主服务器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 主服务器创建db1数据库,从服务器会自动同步<br>CREATE DATABASE db1;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>sqlyog连接从服务器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 从服务器创建db2数据库,主服务器不会自动同步<br>CREATE DATABASE db2;<br></code></pre></div></td></tr></table></figure></li>
<li><p>启动失败的解决方案</p>
</li>
</ul>
<figure class="highlight crmsh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs crmsh">启动失败：Slave_IO_Running为 NO <br>方法一:重置<span class="hljs-literal">slave</span><br><span class="hljs-literal">slave</span> <span class="hljs-literal">stop</span>;<br>reset <span class="hljs-literal">slave</span>;<br><span class="hljs-literal">start</span> <span class="hljs-literal">slave</span> ;<br>方法二:重设同步日志文件及读取位置<br><span class="hljs-literal">slave</span> <span class="hljs-literal">stop</span>;<br>change <span class="hljs-keyword">master</span> <span class="hljs-title">to</span> <span class="hljs-attr">master_log_file=</span>’mysql-bin.<span class="hljs-number">000001</span>’, <span class="hljs-attr">master_log_pos=</span><span class="hljs-number">1</span>;<br><span class="hljs-literal">start</span> <span class="hljs-literal">slave</span> ;<br></code></pre></div></td></tr></table></figure>

<h4 id="5-读写分离"><a href="#5-读写分离" class="headerlink" title="5. 读写分离"></a>5. 读写分离</h4><ul>
<li><p>读写分离的概念</p>
<ul>
<li>写操作只写入主服务器，读操作读取从服务器。</li>
</ul>
</li>
<li><p>在主服务器上修改server.xml</p>
<ul>
<li>user标签主要用于定义登录mycat的用户和权限。如上面定义用户名mycat和密码123456，该用户可以访问的schema的HEIMADB逻辑库。</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">user</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;root&quot;</span> <span class="hljs-attr">defaultAccount</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span>123456<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;schemas&quot;</span>&gt;</span>HEIMADB<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>		<br>		<span class="hljs-comment">&lt;!-- 表级 DML 权限设置 --&gt;</span><br>		<span class="hljs-comment">&lt;!-- 		</span><br><span class="hljs-comment">		&lt;privileges check=&quot;false&quot;&gt;</span><br><span class="hljs-comment">			&lt;schema name=&quot;TESTDB&quot; dml=&quot;0110&quot; &gt;</span><br><span class="hljs-comment">				&lt;table name=&quot;tb01&quot; dml=&quot;0000&quot;&gt;&lt;/table&gt;</span><br><span class="hljs-comment">				&lt;table name=&quot;tb02&quot; dml=&quot;1111&quot;&gt;&lt;/table&gt;</span><br><span class="hljs-comment">			&lt;/schema&gt;</span><br><span class="hljs-comment">		&lt;/privileges&gt;		</span><br><span class="hljs-comment">		 --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<ul>
<li>在主服务器上修改schema.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mycat</span>:schema <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;schema.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mycat:schema</span> <span class="hljs-attr">xmlns:mycat</span>=<span class="hljs-string">&quot;http://io.mycat/&quot;</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">schema</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;HEIMADB&quot;</span> <span class="hljs-attr">checkSQLschema</span>=<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-attr">sqlMaxLimit</span>=<span class="hljs-string">&quot;100&quot;</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">&quot;dn1&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">schema</span>&gt;</span><br>	<br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dn1&quot;</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">&quot;localhost1&quot;</span> <span class="hljs-attr">database</span>=<span class="hljs-string">&quot;db1&quot;</span> /&gt;</span><br>	<br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataHost</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;localhost1&quot;</span> <span class="hljs-attr">maxCon</span>=<span class="hljs-string">&quot;1000&quot;</span> <span class="hljs-attr">minCon</span>=<span class="hljs-string">&quot;10&quot;</span> <span class="hljs-attr">balance</span>=<span class="hljs-string">&quot;1&quot;</span></span><br><span class="hljs-tag">			  <span class="hljs-attr">writeType</span>=<span class="hljs-string">&quot;0&quot;</span> <span class="hljs-attr">dbType</span>=<span class="hljs-string">&quot;mysql&quot;</span> <span class="hljs-attr">dbDriver</span>=<span class="hljs-string">&quot;native&quot;</span> <span class="hljs-attr">switchType</span>=<span class="hljs-string">&quot;1&quot;</span>  <span class="hljs-attr">slaveThreshold</span>=<span class="hljs-string">&quot;100&quot;</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">heartbeat</span>&gt;</span>select user()<span class="hljs-tag">&lt;/<span class="hljs-name">heartbeat</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- 主服务器进行写操作 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">writeHost</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;hostM1&quot;</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;localhost:3306&quot;</span> <span class="hljs-attr">user</span>=<span class="hljs-string">&quot;root&quot;</span></span><br><span class="hljs-tag">				   <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;itheima&quot;</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- 从服务器负责读操作 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">readHost</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;hostS1&quot;</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;192.168.203.135:3306&quot;</span> <span class="hljs-attr">user</span>=<span class="hljs-string">&quot;root&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;itheima&quot;</span> /&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">writeHost</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">dataHost</span>&gt;</span><br>	<br><span class="hljs-tag">&lt;/<span class="hljs-name">mycat:schema</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<ul>
<li><p>配置详解</p>
<ul>
<li><p>schema标签逻辑库的概念和mysql数据库中Datebase的概念相同，我们在查询这两个逻辑库中的表的时候，需要切换到该逻辑库下才可以查到所需要的表。</p>
</li>
<li><p>dataNode属性：该属性用于绑定逻辑库到某个具体的database上。</p>
</li>
<li><p>dataNode标签： dataNode标签定义了mycat中的数据节点，也就是数据分片。一个dataNode标签就是一个独立的数据分片。</p>
</li>
<li><p>name属性：定义数据节点的名字，这个名字需要是唯一的，我们需要在table标签上应用这个名字，来建立表与分片对应的关系。</p>
</li>
<li><p>dataHost属性：该属性用于定义该分片属于那个数据库实例，属性值是引用datahost标签定义的name属性。</p>
</li>
<li><p>database属性：该属性用于定义该分片属于那个具体数据库实例上的具体库，因为这里使用两个纬度来定义分片，就是：实例+具体的库。因为每个库上建立的表和表结构是一样的。所以这样做就可以轻松的对表进行水平拆分。</p>
</li>
<li><p>dataHost标签：该标签在mycat逻辑库中也是作为最底层的标签存在，直接定义了具体的数据库实例、读写分离配置和心跳语句。</p>
</li>
<li><p>balance属性： 负载均衡类型<br>​    balance=0: 不开启读写分离，所有读操作都发送到当前可用的writeHost上。<br>​    balance=1: 全部的readHost与Stand by writeHost都参与select语句的负载均衡<br>​     balance=2: 所有的读操作都随机在writeHost，readHost上分发。<br>​     balance=3: 所有的读请求都随机分配到writeHost对应的readHost上执行，writeHost不负担读压力。</p>
</li>
<li><p>switchType属性：<br>​    -1：表示不自动切换。<br>​    1  ：默认值，表示自动切换<br>​    2：表示基于MySQL主从同步状态决定是否切换，心跳语句： show slave status.<br>​    3:表示基于mysql galary cluster的切换机制，适合mycat1.4之上的版本，心跳语句show status like “%esrep%”;</p>
</li>
<li><p>writeHost标签，readHost标签：这两个标签指定后端数据库的相关配置给mycat，用于实例化后端连接池。唯一不同的是，writeHost指定写实例、readHost指定读实例，组合这些读写实例来满足系统的要求。</p>
<ul>
<li>host属性：用于标识不同的实例，对于writehost，一般使用<em>M1；对于readhost一般使用</em>S1.</li>
<li>url属性：后端实例连接地址，如果使用native的dbDriver，则一般为address:port这种形式，用JDBC或其他的dbDriver，则需要特殊指定。当使用JDBC时则可以这么写：jdbc:mysql://localhost:3306/。</li>
<li>user属性：后端存储实例的用户名。</li>
<li>password属性：后端存储实例的密码</li>
</ul>
</li>
</ul>
</li>
<li><p>测试</p>
<ul>
<li>重启主服务器的mycat</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> 重启mycat<br>cd <span class="hljs-regexp">/root/my</span>cat/bin<br><br>./mycat restart<br><br><span class="hljs-regexp">//</span> 查看端口监听<br>netstat -ant|grep <span class="hljs-number">8066</span><br></code></pre></div></td></tr></table></figure>

<ul>
<li>sqlyog连接mycat</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 创建学生表<br>CREATE TABLE student(<br>	id INT PRIMARY KEY AUTO_INCREMENT,<br>	NAME VARCHAR(10)<br>);<br>-- 查询学生表<br>SELECT * FROM student;<br><br>-- 添加两条记录<br>INSERT INTO student VALUES (NULL,&#39;张三&#39;),(NULL,&#39;李四&#39;);<br><br>-- 停止主从复制后，添加的数据只会保存到主服务器上。<br>INSERT INTO student VALUES (NULL,&#39;王五&#39;);<br></code></pre></div></td></tr></table></figure>

<ul>
<li>sqlyog连接主服务器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 主服务器：查询学生表，可以看到数据<br>SELECT * FROM student;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>sqlyog连接从服务器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 从服务器：查询学生表，可以看到数据(因为有主从复制)<br>SELECT * FROM student;<br><br>-- 从服务器：删除一条记录。(主服务器并没有删除，mycat中间件查询的结果是从服务器的数据)<br>DELETE FROM student WHERE id&#x3D;2;<br></code></pre></div></td></tr></table></figure></li>
</ul>
<h4 id="6-分库分表"><a href="#6-分库分表" class="headerlink" title="6. 分库分表"></a>6. 分库分表</h4><ul>
<li><p>分库分表的概念</p>
<ul>
<li>将庞大的数据进行拆分</li>
<li>水平拆分：根据表的数据逻辑关系，将同一表中的数据按照某种条件，拆分到多台数据库服务器上，也叫做横向拆分。例如：一张1000万的大表，按照一模一样的结构，拆分成4个250万的小表，分别保存到4个数据库中。</li>
<li>垂直拆分：根据业务的维度，将不同的表切分到不同的数据库之上，也叫做纵向拆分。例如：所有的订单都保存到订单库中，所有的用户都保存到用户库中，同类型的表保存在同一库，不同的表分散在不同的库中。</li>
</ul>
</li>
<li><p>Mycat水平拆分</p>
<ul>
<li><p>修改主服务器的server.xml</p>
<ul>
<li><p>0：本地文件方式</p>
<p>在mycat/conf/sequence_conf.properties文件中：<br>GLOBAL.MINDI=10000最小值<br>GLOBAL.MAXID=20000最大值，建议修改到9999999999</p>
</li>
<li><p>1：数据库方式</p>
<p>分库分表中保证全局主键自增唯一，但是需要执行mycat函数，配置sequence_db_conf.properties</p>
</li>
<li><p>2：时间戳方式</p>
<p>mycat实现的时间戳，建议varchar类型，要注意id的长度</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 修改主键的方式 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sequnceHandlerType&quot;</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<ul>
<li>修改主服务器的sequence_conf.properties</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs properties"><span class="hljs-comment">#default global sequence</span><br><span class="hljs-meta">GLOBAL.HISIDS</span>=      <span class="hljs-string"># 可以自定义关键字</span><br><span class="hljs-meta">GLOBAL.MINID</span>=<span class="hljs-string">10001  # 最小值</span><br><span class="hljs-meta">GLOBAL.MAXID</span>=<span class="hljs-string">20000  # 最大值</span><br><span class="hljs-meta">GLOBAL.CURID</span>=<span class="hljs-string">10000</span><br></code></pre></div></td></tr></table></figure>

<ul>
<li>修改主服务器的schema.xml<ul>
<li>table标签定义了逻辑表，所有需要拆分的表都需要在这个标签中定义。 </li>
<li>rule属性：拆分规则。mod-long是拆分规则之一，主键根据服务器数量取模，在rule.xml中指定。如果是3个数据库，那么数据取模后，平均分配到三个库中。</li>
<li>name属性：定义逻辑表的表名，这个名字就如同在数据库中执行create table命令指定的名字一样，同一个schema标签中定义的表名必须是唯一的。</li>
<li>dataNode属性： 定义这个逻辑表所属的dataNode，该属性的值需要和dataNode标签中name属性的值相互对应。</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mycat</span>:schema <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;schema.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mycat:schema</span> <span class="hljs-attr">xmlns:mycat</span>=<span class="hljs-string">&quot;http://io.mycat/&quot;</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">schema</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;HEIMADB&quot;</span> <span class="hljs-attr">checkSQLschema</span>=<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-attr">sqlMaxLimit</span>=<span class="hljs-string">&quot;100&quot;</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;product&quot;</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">&quot;dn1,dn2,dn3&quot;</span> <span class="hljs-attr">rule</span>=<span class="hljs-string">&quot;mod-long&quot;</span>/&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">schema</span>&gt;</span><br>	<br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dn1&quot;</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">&quot;localhost1&quot;</span> <span class="hljs-attr">database</span>=<span class="hljs-string">&quot;db1&quot;</span> /&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dn2&quot;</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">&quot;localhost1&quot;</span> <span class="hljs-attr">database</span>=<span class="hljs-string">&quot;db2&quot;</span> /&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dn3&quot;</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">&quot;localhost1&quot;</span> <span class="hljs-attr">database</span>=<span class="hljs-string">&quot;db3&quot;</span> /&gt;</span><br>	<br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataHost</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;localhost1&quot;</span> <span class="hljs-attr">maxCon</span>=<span class="hljs-string">&quot;1000&quot;</span> <span class="hljs-attr">minCon</span>=<span class="hljs-string">&quot;10&quot;</span> <span class="hljs-attr">balance</span>=<span class="hljs-string">&quot;1&quot;</span></span><br><span class="hljs-tag">			  <span class="hljs-attr">writeType</span>=<span class="hljs-string">&quot;0&quot;</span> <span class="hljs-attr">dbType</span>=<span class="hljs-string">&quot;mysql&quot;</span> <span class="hljs-attr">dbDriver</span>=<span class="hljs-string">&quot;native&quot;</span> <span class="hljs-attr">switchType</span>=<span class="hljs-string">&quot;1&quot;</span>  <span class="hljs-attr">slaveThreshold</span>=<span class="hljs-string">&quot;100&quot;</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">heartbeat</span>&gt;</span>select user()<span class="hljs-tag">&lt;/<span class="hljs-name">heartbeat</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- write --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">writeHost</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;hostM1&quot;</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;localhost:3306&quot;</span> <span class="hljs-attr">user</span>=<span class="hljs-string">&quot;root&quot;</span></span><br><span class="hljs-tag">				   <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;itheima&quot;</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- read --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">readHost</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;hostS1&quot;</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;192.168.203.135:3306&quot;</span> <span class="hljs-attr">user</span>=<span class="hljs-string">&quot;root&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;itheima&quot;</span> /&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">writeHost</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">dataHost</span>&gt;</span><br>	<br><span class="hljs-tag">&lt;/<span class="hljs-name">mycat:schema</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<ul>
<li>修改主服务器的rule.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">function</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;mod-long&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- 数据库的数量 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;count&quot;</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">function</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<ul>
<li><p>测试</p>
<ul>
<li>mycat操作</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 创建product表<br>CREATE TABLE product(<br>	id INT PRIMARY KEY AUTO_INCREMENT,<br>	NAME VARCHAR(20),<br>	price INT<br>);<br><br>-- 添加6条数据<br>INSERT INTO product(id,NAME,price) VALUES (NEXT VALUE FOR MYCATSEQ_GLOBAL,&#39;苹果手机&#39;,6999);<br>INSERT INTO product(id,NAME,price) VALUES (NEXT VALUE FOR MYCATSEQ_GLOBAL,&#39;华为手机&#39;,5999); <br>INSERT INTO product(id,NAME,price) VALUES (NEXT VALUE FOR MYCATSEQ_GLOBAL,&#39;三星手机&#39;,4999); <br>INSERT INTO product(id,NAME,price) VALUES (NEXT VALUE FOR MYCATSEQ_GLOBAL,&#39;小米手机&#39;,3999); <br>INSERT INTO product(id,NAME,price) VALUES (NEXT VALUE FOR MYCATSEQ_GLOBAL,&#39;中兴手机&#39;,2999); <br>INSERT INTO product(id,NAME,price) VALUES (NEXT VALUE FOR MYCATSEQ_GLOBAL,&#39;OOPO手机&#39;,1999); <br><br>-- 查询product表<br>SELECT * FROM product; <br></code></pre></div></td></tr></table></figure>

<ul>
<li>主服务器操作</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 在不同数据库中查询product表<br>SELECT * FROM product;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>从服务器操作</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 在不同数据库中查询product表<br>SELECT * FROM product;<br></code></pre></div></td></tr></table></figure></li>
</ul>
</li>
<li><p>Mycat垂直拆分</p>
<ul>
<li>修改主服务器的schema</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mycat</span>:schema <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;schema.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mycat:schema</span> <span class="hljs-attr">xmlns:mycat</span>=<span class="hljs-string">&quot;http://io.mycat/&quot;</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">schema</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;HEIMADB&quot;</span> <span class="hljs-attr">checkSQLschema</span>=<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-attr">sqlMaxLimit</span>=<span class="hljs-string">&quot;100&quot;</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;product&quot;</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">&quot;dn1,dn2,dn3&quot;</span> <span class="hljs-attr">rule</span>=<span class="hljs-string">&quot;mod-long&quot;</span>/&gt;</span><br>		<br>		<span class="hljs-comment">&lt;!-- 动物类数据表 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dog&quot;</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">autoIncrement</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">&quot;dn4&quot;</span> /&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cat&quot;</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">autoIncrement</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">&quot;dn4&quot;</span> /&gt;</span><br>    <br>       <span class="hljs-comment">&lt;!-- 水果类数据表 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;apple&quot;</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">autoIncrement</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">&quot;dn5&quot;</span> /&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;banana&quot;</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">autoIncrement</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">dataNode</span>=<span class="hljs-string">&quot;dn5&quot;</span> /&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">schema</span>&gt;</span><br>	<br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dn1&quot;</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">&quot;localhost1&quot;</span> <span class="hljs-attr">database</span>=<span class="hljs-string">&quot;db1&quot;</span> /&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dn2&quot;</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">&quot;localhost1&quot;</span> <span class="hljs-attr">database</span>=<span class="hljs-string">&quot;db2&quot;</span> /&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dn3&quot;</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">&quot;localhost1&quot;</span> <span class="hljs-attr">database</span>=<span class="hljs-string">&quot;db3&quot;</span> /&gt;</span><br>	<br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dn4&quot;</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">&quot;localhost1&quot;</span> <span class="hljs-attr">database</span>=<span class="hljs-string">&quot;db4&quot;</span> /&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataNode</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dn5&quot;</span> <span class="hljs-attr">dataHost</span>=<span class="hljs-string">&quot;localhost1&quot;</span> <span class="hljs-attr">database</span>=<span class="hljs-string">&quot;db5&quot;</span> /&gt;</span><br>	<br>	<span class="hljs-tag">&lt;<span class="hljs-name">dataHost</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;localhost1&quot;</span> <span class="hljs-attr">maxCon</span>=<span class="hljs-string">&quot;1000&quot;</span> <span class="hljs-attr">minCon</span>=<span class="hljs-string">&quot;10&quot;</span> <span class="hljs-attr">balance</span>=<span class="hljs-string">&quot;1&quot;</span></span><br><span class="hljs-tag">			  <span class="hljs-attr">writeType</span>=<span class="hljs-string">&quot;0&quot;</span> <span class="hljs-attr">dbType</span>=<span class="hljs-string">&quot;mysql&quot;</span> <span class="hljs-attr">dbDriver</span>=<span class="hljs-string">&quot;native&quot;</span> <span class="hljs-attr">switchType</span>=<span class="hljs-string">&quot;1&quot;</span>  <span class="hljs-attr">slaveThreshold</span>=<span class="hljs-string">&quot;100&quot;</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">heartbeat</span>&gt;</span>select user()<span class="hljs-tag">&lt;/<span class="hljs-name">heartbeat</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- write --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">writeHost</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;hostM1&quot;</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;localhost:3306&quot;</span> <span class="hljs-attr">user</span>=<span class="hljs-string">&quot;root&quot;</span></span><br><span class="hljs-tag">				   <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;itheima&quot;</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- read --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">readHost</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;hostS1&quot;</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;192.168.203.135:3306&quot;</span> <span class="hljs-attr">user</span>=<span class="hljs-string">&quot;root&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;itheima&quot;</span> /&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">writeHost</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">dataHost</span>&gt;</span><br>	<br><span class="hljs-tag">&lt;/<span class="hljs-name">mycat:schema</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<ul>
<li><p>测试</p>
<ul>
<li>sqlyog连接mycat</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 创建dog表<br>CREATE TABLE dog(<br>	id INT PRIMARY KEY AUTO_INCREMENT,<br>	NAME VARCHAR(10)<br>);<br>-- 添加数据<br>INSERT INTO dog(id,NAME) VALUES (NEXT VALUE FOR MYCATSEQ_GLOBAL,&#39;哈士奇&#39;);<br>-- 查询dog表<br>SELECT * FROM dog;<br><br><br>-- 创建cat表<br>CREATE TABLE cat(<br>	id INT PRIMARY KEY AUTO_INCREMENT,<br>	NAME VARCHAR(10)<br>);<br>-- 添加数据<br>INSERT INTO cat(id,NAME) VALUES (NEXT VALUE FOR MYCATSEQ_GLOBAL,&#39;波斯猫&#39;);<br>-- 查询cat表<br>SELECT * FROM cat;<br><br><br><br>-- 创建apple表<br>CREATE TABLE apple(<br>	id INT PRIMARY KEY AUTO_INCREMENT,<br>	NAME VARCHAR(10)<br>);<br>-- 添加数据<br>INSERT INTO apple(id,NAME) VALUES (NEXT VALUE FOR MYCATSEQ_GLOBAL,&#39;红富士&#39;);<br>-- 查询apple表<br>SELECT * FROM apple;<br><br><br>-- 创建banana表<br>CREATE TABLE banana(<br>	id INT PRIMARY KEY AUTO_INCREMENT,<br>	NAME VARCHAR(10)<br>);<br>-- 添加数据<br>INSERT INTO banana(id,NAME) VALUES (NEXT VALUE FOR MYCATSEQ_GLOBAL,&#39;香蕉&#39;);<br>-- 查询banana表<br>SELECT * FROM banana;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>sqlyog连接主服务器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 查询dog表<br>SELECT * FROM dog;<br>-- 查询cat表<br>SELECT * FROM cat;<br><br><br>-- 查询apple表<br>SELECT * FROM apple;<br>-- 查询banana表<br>SELECT * FROM banana;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>sqlyog连接从服务器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">-- 查询dog表<br>SELECT * FROM dog;<br>-- 查询cat表<br>SELECT * FROM cat;<br><br><br>-- 查询apple表<br>SELECT * FROM apple;<br>-- 查询banana表<br>SELECT * FROM banana;<br></code></pre></div></td></tr></table></figure></li>
</ul>
</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/MySQL/">MySQL</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/MySQL/">MySQL</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/05/05/Javaweb05/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">EL&Filter&Listener</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/05/04/jdbc02/">
                        <span class="hidden-mobile">JDBC-02</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.lazyComments('valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function () {
        new Valine({
          el: "#valine",
          app_id: "7FicXKczRMSUD3slGCpiLLto-gzGzoHsz",
          app_key: "L7N1wkygdm2UHsrq5DHTuMMk",
          placeholder: "说点什么",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: true,
          recordIP: true,
          serverURLs: "https://7ficxkcz.lc-cn-n1-shared.com",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the
    <a target="_blank" href="https://valine.js.org" rel="nofollow noopener noopener">comments powered by Valine.</a>
  </noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <a target="_blank" href="https://www.12377.cn/" rel="nofollow noopener noopener">中央网信办（国家互联网信息办公室）违法和不良信息举报中心</a>

  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        京ICP证123456号
      </a>
    </span>
    
      
        <span>
          <a
            href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
            rel="nofollow noopener"
            class="beian-police"
            target="_blank"
          >
            
              <span style="visibility: hidden; width: 0">|</span>
              <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
            
            <span>京公网安备12345678号</span>
          </a>
        </span>
      
    
  </div>


  
  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>


  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-svg.js" ></script>

  








  

  

  

  

  
    <!-- 51.la Analytics -->
    <script defer type="text/javascript" src="//js.users.51.la/21111747.js"></script>
  

  




  
<script src="/js/caidai.js"></script>
<script src="/js/dianjichuzi.js"></script>



<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>

  <script type="text/javascript" src="//js.users.51.la/21111747.js"></script>
</body>
</html>
